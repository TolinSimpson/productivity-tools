<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>üìù Notebook</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            height: 100vh;
            overflow: hidden;
            padding-bottom: 70px;
        }
        .header {
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 50;
            min-height: 60px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            white-space: nowrap;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }
        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 6px;
            min-width: 36px;
            min-height: 36px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .encryption-btn {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .encryption-btn:hover {
            background: #fde68a;
        }
        .encryption-btn.active {
            background: #065f46;
            color: #fff;
            border-color: #065f46;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        .view {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 70px;
            background: #fff;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: none;
        }
        .view.active {
            display: block;
        }
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #e2e8f0;
            z-index: 100;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .nav-tabs {
            display: flex;
            height: 70px;
            max-width: 600px;
            margin: 0 auto;
        }
        .nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            gap: 6px;
            padding: 8px;
        }
        .nav-tab.active {
            color: #3b82f6;
            background: #eff6ff;
        }
        .nav-tab:hover {
            background: #f8fafc;
        }
        .nav-icon {
            font-size: 1.4rem;
        }
        .editor {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .editor-header {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .note-title-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }
        .tag-management {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid #0284c7;
        }
        .tag-remove {
            background: none;
            border: none;
            color: #0369a1;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0;
            margin-left: 2px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tag-remove:hover {
            background: #0284c7;
            color: #fff;
        }
        .add-tag-btn {
            background: #10b981;
            color: #fff;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .add-tag-btn:hover {
            background: #059669;
        }
        .editor-toolbar {
            padding: 8px 16px;
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 9;
            overflow-x: auto;
        }
        .toolbar-scroll {
            display: flex;
            gap: 4px;
            min-width: max-content;
            padding-bottom: 4px;
        }
        .toolbar-group {
            display: flex;
            gap: 1px;
            padding: 2px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #e2e8f0;
            flex-shrink: 0;
        }
        .toolbar-btn {
            padding: 6px 8px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toolbar-btn:hover {
            background: #f1f5f9;
            color: #3b82f6;
        }
        .toolbar-btn.active {
            background: #3b82f6;
            color: #fff;
        }
        .editor-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        .editor-textarea {
            min-height: calc(100vh - 300px);
            outline: none;
            line-height: 1.6;
            font-size: 1rem;
            word-wrap: break-word;
            width: 100%;
            border: none;
            background: none;
            resize: none;
        }
        .editor-textarea:empty::before {
            content: "Start writing your note...";
            color: #9ca3af;
        }
        .status-bar {
            padding: 12px 16px;
            border-top: 1px solid #f1f5f9;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6b7280;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .notes-controls {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .search-section {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            outline: none;
            min-width: 120px;
            cursor: pointer;
        }
        .filter-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .notes-list {
            padding: 8px 0;
        }
        .note-item {
            position: relative;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .note-item:hover, .note-item:active {
            background: #f8fafc;
        }
        .note-item.active {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding-left: 12px;
        }
        .note-content {
            padding-right: 40px;
        }
        .note-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .note-preview {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .note-delete {
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 1;
            background: #fef2f2;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            font-size: 1rem;
            transition: all 0.2s;
            z-index: 10;
        }
        .note-delete:hover {
            background: #fecaca;
            color: #b91c1c;
            transform: scale(1.05);
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
        }
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .save-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }
        .save-dot.saving {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @media (max-width: 768px) {
            .header {
                padding: 10px 16px;
            }
            .header-title {
                font-size: 1.1rem;
            }
            .header-left {
                gap: 8px;
            }
            .header-actions {
                gap: 6px;
            }
            .btn-icon {
                min-width: 32px;
                min-height: 32px;
                padding: 6px;
                font-size: 0.9rem;
            }
            .search-section {
                flex-direction: column;
                align-items: stretch;
            }
            .search-input {
                min-width: unset;
            }
            .filter-select {
                min-width: unset;
            }
        }
        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            .header-title {
                font-size: 1rem;
            }
            .header-left {
                gap: 6px;
            }
            .header-actions {
                gap: 4px;
            }
            .btn-icon {
                min-width: 28px;
                min-height: 28px;
                padding: 4px;
                font-size: 0.8rem;
            }
            .notes-controls {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1 class="header-title">üìù Notebook</h1>
        </div>
        <div class="header-actions">
            <button class="btn-icon encryption-btn" onclick="toggleEncryption()" id="encryptionBtn" title="Toggle encryption">üîí</button>
            <button class="btn btn-primary" onclick="createNote()">üìù New Note</button>
        </div>
    </div>

    <!-- Hidden encryption checkbox for functionality -->
    <input type="checkbox" id="encryptionEnabled" style="display:none">

    <!-- Editor View -->
    <div class="view active" id="EditorView">
        <div class="editor">
            <div class="editor-header">
                <div class="note-title-display" id="noteTitleDisplay">Select a note to edit</div>
                <div class="tag-management">
                    <label for="tagSelect" style="font-size:0.9rem;color:#6b7280;margin-right:8px;">Tags:</label>
                    <select class="btn btn-secondary" id="tagSelect" onchange="handleTagChange()">
                        <option value="">Add tag...</option>
                    </select>
                    <div class="note-tags" id="noteTags"></div>
                </div>
            </div>
            <div class="editor-toolbar">
                <div class="toolbar-scroll">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="ToggleFormat('bold')" data-format="bold" title="Bold"><strong>B</strong></button>
                        <button class="toolbar-btn" onclick="ToggleFormat('italic')" data-format="italic" title="Italic"><em>I</em></button>
                        <button class="toolbar-btn" onclick="ToggleFormat('underline')" data-format="underline" title="Underline"><u>U</u></button>
                        <button class="toolbar-btn" onclick="ToggleFormat('strikeThrough')" data-format="strikeThrough" title="Strikethrough"><s>S</s></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="FormatHeading('h1')" data-format="h1" title="Heading 1">H1</button>
                        <button class="toolbar-btn" onclick="FormatHeading('h2')" data-format="h2" title="Heading 2">H2</button>
                        <button class="toolbar-btn" onclick="FormatHeading('h3')" data-format="h3" title="Heading 3">H3</button>
                        <button class="toolbar-btn" onclick="FormatHeading('p')" data-format="p" title="Paragraph">P</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="ToggleFormat('insertUnorderedList')" data-format="insertUnorderedList" title="Bullet List">‚Ä¢ List</button>
                        <button class="toolbar-btn" onclick="ToggleFormat('insertOrderedList')" data-format="insertOrderedList" title="Numbered List">1. List</button>
                        <button class="toolbar-btn" onclick="ToggleCodeFormat()" data-format="code" title="Code">&lt;/&gt;</button>
                        <button class="toolbar-btn" onclick="ToggleQuoteFormat()" data-format="quote" title="Quote">‚ùù</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="CreateLink()" data-format="createLink" title="Insert Link">üîó</button>
                        <button class="toolbar-btn" onclick="InsertImage()" title="Insert Image">üñº</button>
                        <button class="toolbar-btn" onclick="ClearFormatting()" title="Clear Formatting">üßπ</button>
                    </div>
                </div>
            </div>
            <div class="editor-content">
                <div class="editor-textarea" contenteditable="true" id="Editor"></div>
            </div>
            <div class="status-bar">
                <div class="auto-save-indicator">
                    <div class="save-dot" id="SaveDot"></div>
                    <span id="SaveStatus">All changes saved</span>
                </div>
                <div id="WordCount">0 words</div>
            </div>
        </div>
    </div>

    <!-- Notes View -->
    <div class="view" id="NotesView">
        <div class="notes-controls">
            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="Search notes..." onkeyup="searchNotes()">
                <select class="filter-select" id="tagFilter" onchange="filterNotesByTag()">
                    <option value="">All Tags</option>
                </select>
                <button class="btn btn-primary" onclick="createNote()">üìù New Note</button>
            </div>
        </div>
        <div class="notes-list" id="NotesList"></div>
    </div>

    <!-- Bottom Navigation -->
    <div class="nav">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('editor')" data-view="editor">
                <div class="nav-icon">‚úèÔ∏è</div>
                <div>Editor</div>
            </button>
            <button class="nav-tab" onclick="showView('notes')" data-view="notes">
                <div class="nav-icon">üìÑ</div>
                <div>Notes</div>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="encrypted-storage.js"></script>
    <script>
        // Global state using encrypted storage
        let notes = {};
        let tags = [];
        let currentNote = null;
        let autoSaveTimer = null;
        let pendingChanges = false;
        let encryptionEnabled = false;
        let storage = null;

        // Initialize storage
        async function initStorage() {
            try {
                if (typeof EncryptedStorage !== 'undefined') {
                    storage = new EncryptedStorage();
                } else {
                    // Fallback storage
                    storage = {
                        async saveEncrypted(key, data) {
                            localStorage.setItem(key, JSON.stringify(data));
                            return true;
                        },
                        async loadEncrypted(key) {
                            const data = localStorage.getItem(key);
                            return data ? JSON.parse(data) : null;
                        }
                    };
                }
                await loadData();
            } catch (error) {
                console.error('Storage initialization failed:', error);
            }
        }

        // Load data from storage
        async function loadData() {
            try {
                const data = await storage.loadEncrypted('notebook-data');
                if (data) {
                    notes = data.notes || {};
                    tags = data.tags || [];
                    encryptionEnabled = data.settings?.encryptionEnabled || false;
                } else {
                    // Default data
                    notes = {
                        '1': {
                            id: '1',
                            title: 'Welcome to your Notebook! üëã',
                            content: '<h2>Getting Started</h2><p>Welcome to your unified productivity workspace! Here\'s how to get started:</p><ul><li><strong>Create notes:</strong> Click the "New Note" button</li><li><strong>Organize:</strong> Use tags to organize your notes</li><li><strong>Format:</strong> Use the toolbar to style your text</li></ul><p>Your notes are automatically saved and work completely offline. Happy note-taking! ‚ú®</p>',
                            tags: ['welcome'],
                            created: new Date().toISOString(),
                            modified: new Date().toISOString()
                        }
                    };
                    tags = ['welcome'];
                }
                
                updateEncryptionUI();
                updateAllViews();
                
                // Load first note
                const noteIds = Object.keys(notes);
                if (noteIds.length > 0) {
                    SelectNote(noteIds[0]);
                }
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        // Save data to storage
        async function saveData() {
            try {
                const data = {
                    notes: notes,
                    tags: tags,
                    settings: { encryptionEnabled: encryptionEnabled }
                };
                await storage.saveEncrypted('notebook-data', data);
                setSaveStatus('saved');
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        // Initialize app
        async function init() {
            await initStorage();
            showView('editor');
            setupEventListeners();
        }

        function setupEventListeners() {
            const Editor = document.getElementById('Editor');
            Editor.addEventListener('input', () => {
                UpdateWordCount();
                ScheduleAutoSave();
            });
            Editor.addEventListener('keyup', UpdateToolbarState);
            Editor.addEventListener('mouseup', UpdateToolbarState);
        }

        function ScheduleAutoSave() {
            setSaveStatus('saving');
            pendingChanges = true;
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(async () => {
                if (currentNote) {
                    await saveCurrentNote();
                    await saveData();
                }
            }, 1000);
        }

        function setSaveStatus(status) {
            const dot = document.getElementById('SaveDot');
            const text = document.getElementById('SaveStatus');
            if (status === 'saving') {
                dot.classList.add('saving');
                text.textContent = 'Saving...';
            } else {
                dot.classList.remove('saving');
                text.textContent = 'All changes saved';
            }
        }

        function UpdateWordCount() {
            const content = document.getElementById('Editor').textContent || '';
            const words = content.trim() ? content.trim().split(/\s+/).length : 0;
            document.getElementById('WordCount').textContent = `${words} word${words !== 1 ? 's' : ''}`;
        }

        async function saveCurrentNote() {
            if (!currentNote || !notes[currentNote]) return;
            
            notes[currentNote].content = document.getElementById('Editor').innerHTML;
            notes[currentNote].modified = new Date().toISOString();
            updateNotesList();
        }

        function showView(view) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${view.charAt(0).toUpperCase() + view.slice(1)}View`).classList.add('active');
            
            if (view === 'notes') {
                updateNotesList();
                updateTagFilter();
            }
        }

        function updateAllViews() {
            updateNotesList();
            updateTagSelect();
            updateNoteDisplay();
        }

        function updateNotesList() {
            const container = document.getElementById('NotesList');
            const searchInput = document.getElementById('searchInput');
            const tagFilter = document.getElementById('tagFilter');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const selectedTag = tagFilter ? tagFilter.value : '';

            let allNotes = Object.entries(notes).map(([id, note]) => ({id, note}));

            // Apply search filter
            if (searchTerm) {
                allNotes = allNotes.filter(({note}) => {
                    const title = (note.title || '').toLowerCase();
                    const content = note.content.replace(/<[^>]*>/g, '').toLowerCase();
                    const tags = (note.tags || []).join(' ').toLowerCase();
                    return title.includes(searchTerm) || content.includes(searchTerm) || tags.includes(searchTerm);
                });
            }

            // Apply tag filter
            if (selectedTag) {
                allNotes = allNotes.filter(({note}) => (note.tags || []).includes(selectedTag));
            }

            allNotes.sort((a, b) => new Date(b.note.modified) - new Date(a.note.modified));

            container.innerHTML = allNotes.length ? allNotes.map(({id, note}) => {
                const displayTitle = note.title || 'Untitled Note';
                const contentText = note.content.replace(/<[^>]*>/g, '');
                const preview = contentText.substring(0, 100);
                const wordCount = contentText.trim() ? contentText.trim().split(/\s+/).length : 0;
                const date = new Date(note.modified).toLocaleDateString();
                const noteTags = note.tags || [];

                const tagsHTML = noteTags.map(tag => `<span class="tag-item">${tag}</span>`).join('');

                return `<div class="note-item ${id === currentNote ? 'active' : ''}" onclick="SelectNote('${id}')">
                    <button class="note-delete" onclick="event.stopPropagation();deleteNote('${id}')" title="Delete note">üóëÔ∏è</button>
                    <div class="note-content">
                        <div class="note-title">${displayTitle}</div>
                        <div class="note-preview">${preview}${preview.length >= 100 ? '...' : ''}</div>
                        <div class="note-meta">
                            <span>${date}</span>
                            <span>${wordCount} word${wordCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="note-tags">${tagsHTML}</div>
                    </div>
                </div>`;
            }).join('') : `<div class="empty-state">
                <div class="empty-icon">üìù</div>
                <p>No notes yet</p>
            </div>`;
        }

        function updateTagSelect() {
            const select = document.getElementById('tagSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Add tag...</option>' + 
                tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
        }

        function updateTagFilter() {
            const filter = document.getElementById('tagFilter');
            if (!filter) return;
            filter.innerHTML = '<option value="">All Tags</option>' + 
                tags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
        }

        function updateNoteDisplay() {
            const titleDisplay = document.getElementById('noteTitleDisplay');
            const noteTagsContainer = document.getElementById('noteTags');
            
            if (currentNote && notes[currentNote]) {
                titleDisplay.textContent = notes[currentNote].title || 'Untitled Note';
                const noteTags = notes[currentNote].tags || [];
                noteTagsContainer.innerHTML = noteTags.map(tag => 
                    `<span class="tag-item">${tag}<button class="tag-remove" onclick="removeTagFromNote('${currentNote}','${tag}')" title="Remove tag">√ó</button></span>`
                ).join('');
            } else {
                titleDisplay.textContent = 'Select a note to edit';
                noteTagsContainer.innerHTML = '';
            }
        }

        function searchNotes() {
            updateNotesList();
        }

        function filterNotesByTag() {
            updateNotesList();
        }

        function handleTagChange() {
            const select = document.getElementById('tagSelect');
            const selectedTag = select.value;
            if (selectedTag && currentNote) {
                addTagToNote(currentNote, selectedTag);
                select.value = '';
                updateNoteDisplay();
                updateNotesList();
                ScheduleAutoSave();
            }
        }

        function addTagToNote(noteId, tag) {
            if (!notes[noteId]) return;
            if (!notes[noteId].tags) notes[noteId].tags = [];
            if (!notes[noteId].tags.includes(tag)) {
                notes[noteId].tags.push(tag);
                if (!tags.includes(tag)) {
                    tags.push(tag);
                    updateTagSelect();
                    updateTagFilter();
                }
            }
        }

        function removeTagFromNote(noteId, tag) {
            if (!notes[noteId] || !notes[noteId].tags) return;
            notes[noteId].tags = notes[noteId].tags.filter(t => t !== tag);
            updateNoteDisplay();
            updateNotesList();
            ScheduleAutoSave();
        }

        function deleteNote(noteId) {
            if (!confirm('Delete this note? This cannot be undone.')) return;
            
            delete notes[noteId];
            if (currentNote === noteId) {
                const remainingNotes = Object.keys(notes);
                if (remainingNotes.length > 0) {
                    SelectNote(remainingNotes[0]);
                } else {
                    currentNote = null;
                    document.getElementById('Editor').innerHTML = '';
                    updateNoteDisplay();
                }
            }
            updateNotesList();
            ScheduleAutoSave();
        }

        function SelectNote(noteId) {
            if (!notes[noteId]) return;
            
            const note = notes[noteId];
            currentNote = noteId;
            document.getElementById('Editor').innerHTML = note.content;
            updateAllViews();
            UpdateWordCount();
            setSaveStatus('saved');
            showView('editor');
        }

        function createNote() {
            const title = prompt('Enter note title:');
            if (!title || !title.trim()) return;
            
            const noteId = Date.now().toString();
            notes[noteId] = {
                title: title.trim(),
                content: '',
                tags: [],
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            
            SelectNote(noteId);
            updateNotesList();
            ScheduleAutoSave();
        }

        // Formatting functions
        function ToggleFormat(command) {
            document.getElementById('Editor').focus();
            document.execCommand(command, false, null);
            UpdateToolbarState();
            ScheduleAutoSave();
        }

        function FormatHeading(tag) {
            document.getElementById('Editor').focus();
            document.execCommand('formatBlock', false, tag);
            UpdateToolbarState();
            ScheduleAutoSave();
        }

        function CreateLink() {
            document.getElementById('Editor').focus();
            const url = prompt('Enter URL:', 'https://');
            if (url && url !== 'https://') {
                const selection = window.getSelection();
                const selectedText = selection.toString();
                const text = selectedText || prompt('Enter link text:');
                if (text) {
                    document.execCommand('insertHTML', false, `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`);
                }
            }
            UpdateToolbarState();
            ScheduleAutoSave();
        }

        function InsertImage() {
            const url = prompt('Enter image URL:', 'https://');
            if (url && url !== 'https://') {
                document.getElementById('Editor').focus();
                document.execCommand('insertHTML', false, `<img src="${url}" style="max-width:100%;height:auto;border-radius:4px;margin:8px 0;" alt="Image">`);
                ScheduleAutoSave();
            }
        }

        function ToggleCodeFormat() {
            document.getElementById('Editor').focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const selectedText = selection.toString();
                if (selectedText) {
                    const code = `<code style="background:#f1f5f9;padding:2px 4px;border-radius:3px;font-family:Monaco,monospace;">${selectedText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code>`;
                    document.execCommand('insertHTML', false, code);
                }
            }
            UpdateToolbarState();
            ScheduleAutoSave();
        }

        function ToggleQuoteFormat() {
            document.getElementById('Editor').focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const selectedText = selection.toString();
                if (selectedText) {
                    document.execCommand('insertHTML', false, `<blockquote style="border-left:4px solid #3b82f6;padding:12px 16px;margin:16px 0;font-style:italic;color:#6b7280;background:#f8fafc;">${selectedText}</blockquote>`);
                }
            }
            UpdateToolbarState();
            ScheduleAutoSave();
        }

        function ClearFormatting() {
            const editor = document.getElementById('Editor');
            editor.focus();
            document.execCommand('removeFormat');
            document.execCommand('formatBlock', false, 'p');
            UpdateToolbarState();
            ScheduleAutoSave();
        }

        function UpdateToolbarState() {
            document.querySelectorAll('.toolbar-btn[data-format]').forEach(button => {
                button.classList.remove('active');
                const format = button.getAttribute('data-format');
                
                if (['h1', 'h2', 'h3', 'p'].includes(format)) {
                    const blockFormat = document.queryCommandValue('formatBlock').toLowerCase();
                    if (blockFormat === format || (format === 'p' && !blockFormat)) {
                        button.classList.add('active');
                    }
                } else if (['bold', 'italic', 'underline', 'strikeThrough'].includes(format)) {
                    if (document.queryCommandState(format)) {
                        button.classList.add('active');
                    }
                } else if (['insertUnorderedList', 'insertOrderedList'].includes(format)) {
                    if (document.queryCommandState(format)) {
                        button.classList.add('active');
                    }
                }
            });
        }

        // Encryption functions
        function updateEncryptionUI() {
            const btn = document.getElementById('encryptionBtn');
            const checkbox = document.getElementById('encryptionEnabled');
            
            checkbox.checked = encryptionEnabled;
            btn.classList.toggle('active', encryptionEnabled);
            btn.title = encryptionEnabled ? 'Encryption enabled - click to disable' : 'Toggle encryption';
        }

        async function toggleEncryption() {
            encryptionEnabled = !encryptionEnabled;
            
            // Update all notes
            Object.values(notes).forEach(note => {
                note.encrypted = encryptionEnabled;
            });

            updateEncryptionUI();
            await saveData();
            
            alert(`Encryption ${encryptionEnabled ? 'enabled' : 'disabled'}!`);
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
