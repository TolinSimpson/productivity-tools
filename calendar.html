<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Event Manager</title>
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #4285f4;
            --primary-dark: #3367d6;
            --secondary-color: #34a853;
            --accent-color: #fbbc04;
            --danger-color: #ea4335;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --text-muted: #9aa0a6;
            --border-color: #dadce0;
            --surface-color: #ffffff;
            --background-color: #f8f9fa;
            --surface-elevated: #ffffff;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .calendar-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface-color);
        }

        /* Header */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-elevated);
            flex-shrink: 0;
        }

        .calendar-title {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--surface-elevated);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .nav-button:hover {
            background: var(--background-color);
            border-color: var(--text-secondary);
        }

        .nav-button.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .nav-button.primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .nav-button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Calendar Main Content */
        .calendar-main {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .calendar-sidebar {
            width: 280px;
            border-right: 1px solid var(--border-color);
            background: var(--surface-elevated);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section h3 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .calendar-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Month View */
        .month-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-lg);
        }

        .month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .day-header {
            background: var(--surface-elevated);
            padding: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
            flex: 1;
            min-height: 400px;
        }

        .day-cell {
            background: var(--surface-elevated);
            padding: var(--spacing-sm);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .day-cell:hover {
            background: var(--background-color);
        }

        .day-cell.other-month {
            background: var(--background-color);
            color: var(--text-muted);
        }

        .day-cell.today {
            background: rgba(66, 133, 244, 0.1);
            border: 2px solid var(--primary-color);
        }

        .day-cell.selected {
            background: var(--primary-color);
            color: white;
        }

        .day-number {
            font-weight: 600;
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-xs);
        }

        .day-events {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .event-item {
            background: var(--accent-color);
            color: var(--text-primary);
            padding: 2px var(--spacing-xs);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
        }

        .event-item.priority-high {
            background: var(--danger-color);
            color: white;
        }

        .event-item.priority-medium {
            background: var(--accent-color);
            color: var(--text-primary);
        }

        .event-item.priority-low {
            background: var(--secondary-color);
            color: white;
        }

        /* Week View */
        .week-view {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: var(--spacing-lg);
        }

        .week-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .time-label {
            background: var(--surface-elevated);
            padding: var(--spacing-sm);
            text-align: center;
            font-weight: 600;
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .week-day-header {
            background: var(--surface-elevated);
            padding: var(--spacing-sm);
            text-align: center;
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .week-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
            flex: 1;
            max-height: 600px;
            overflow-y: auto;
        }

        .hour-label {
            background: var(--surface-elevated);
            padding: var(--spacing-sm);
            text-align: center;
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            border-right: 1px solid var(--border-color);
        }

        .hour-slot {
            background: var(--surface-elevated);
            min-height: 40px;
            padding: 2px;
            cursor: pointer;
            position: relative;
        }

        .hour-slot:hover {
            background: var(--background-color);
        }

        /* Event Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--spacing-md);
        }

        .modal-content {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-2xl);
            cursor: pointer;
            color: var(--text-secondary);
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
        }

        .modal-close:hover {
            background: var(--background-color);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--surface-elevated);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--surface-elevated);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .btn-danger:hover {
            background: #c82333;
            border-color: #c82333;
        }

        /* Mini Calendar */
        .mini-calendar {
            margin-bottom: var(--spacing-lg);
        }

        .mini-month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .mini-month-title {
            font-weight: 600;
            font-size: var(--font-size-base);
        }

        .mini-nav-btn {
            background: none;
            border: none;
            padding: var(--spacing-xs);
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
        }

        .mini-nav-btn:hover {
            background: var(--background-color);
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .mini-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background-color 0.2s ease;
        }

        .mini-day:hover {
            background: var(--background-color);
        }

        .mini-day.today {
            background: var(--primary-color);
            color: white;
        }

        .mini-day.other-month {
            color: var(--text-muted);
        }

        /* Event List */
        .event-list {
            flex: 1;
            overflow-y: auto;
        }

        .event-list-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .event-list-item:hover {
            background: var(--background-color);
        }

        .event-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .event-details {
            flex: 1;
            min-width: 0;
        }

        .event-title {
            font-weight: 500;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .event-time {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .calendar-sidebar {
                display: none;
            }
            
            .calendar-header {
                padding: var(--spacing-sm);
                flex-wrap: wrap;
                gap: var(--spacing-sm);
            }
            
            .calendar-nav {
                gap: var(--spacing-sm);
            }
            
            .nav-button {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--font-size-xs);
            }
            
            .month-view, .week-view {
                padding: var(--spacing-sm);
            }
            
            .day-cell {
                min-height: 60px;
            }
            
            .modal-content {
                margin: var(--spacing-sm);
            }
        }

        .hidden {
            display: none !important;
        }

        /* Today indicator */
        .is-today {
            background: rgba(66, 133, 244, 0.1) !important;
            border: 2px solid var(--primary-color) !important;
        }

        /* Selected date */
        .is-selected {
            background: var(--primary-color) !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <!-- Header -->
        <div class="calendar-header">
            <h1 class="calendar-title" id="calendar-title">Calendar</h1>
            <div class="calendar-nav">
                <button class="nav-button" id="prev-period" title="Previous">←</button>
                <button class="nav-button" id="today-btn">Today</button>
                <button class="nav-button" id="next-period" title="Next">→</button>
                <button class="nav-button active" id="month-view-btn">Month</button>
                <button class="nav-button" id="week-view-btn">Week</button>
                <button class="nav-button primary" id="new-event-btn">+ New Event</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="calendar-main">
            <!-- Sidebar -->
            <div class="calendar-sidebar">
                <!-- Mini Calendar -->
                <div class="sidebar-section">
                    <div class="mini-calendar">
                        <div class="mini-month-nav">
                            <button class="mini-nav-btn" id="mini-prev">←</button>
                            <span class="mini-month-title" id="mini-month-title">December 2024</span>
                            <button class="mini-nav-btn" id="mini-next">→</button>
                        </div>
                        <div class="mini-grid" id="mini-calendar-grid">
                            <!-- Mini calendar days will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Upcoming Events -->
                <div class="sidebar-section">
                    <h3>Upcoming Events</h3>
                    <div class="event-list" id="upcoming-events">
                        <!-- Upcoming events will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Calendar Views -->
            <div class="calendar-view">
                <!-- Month View -->
                <div class="month-view" id="month-view">
                    <div class="month-header">
                        <div class="day-header">Sun</div>
                        <div class="day-header">Mon</div>
                        <div class="day-header">Tue</div>
                        <div class="day-header">Wed</div>
                        <div class="day-header">Thu</div>
                        <div class="day-header">Fri</div>
                        <div class="day-header">Sat</div>
                    </div>
                    <div class="month-grid" id="month-grid">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>

                <!-- Week View -->
                <div class="week-view" id="week-view">
                    <div class="week-header" id="week-header">
                        <div class="time-label"></div>
                        <!-- Week day headers will be generated here -->
                    </div>
                    <div class="week-grid" id="week-grid">
                        <!-- Week view will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal-overlay" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">New Event</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <div class="form-group">
                        <label for="event-title">Title</label>
                        <input type="text" id="event-title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea id="event-description" class="form-input form-textarea"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="event-date">Date</label>
                            <input type="date" id="event-date" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="event-time">Time</label>
                            <input type="time" id="event-time" class="form-input">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="event-priority">Priority</label>
                            <select id="event-priority" class="form-select">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event-category">Category</label>
                            <select id="event-category" class="form-select">
                                <option value="personal">Personal</option>
                                <option value="work">Work</option>
                                <option value="health">Health</option>
                                <option value="social">Social</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="event-reminder">Reminder</label>
                        <select id="event-reminder" class="form-select">
                            <option value="none">No reminder</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                            <option value="60">1 hour before</option>
                            <option value="1440">1 day before</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="nav-button btn-danger hidden" id="delete-event-btn">Delete</button>
                <button type="button" class="nav-button" id="cancel-btn">Cancel</button>
                <button type="submit" class="nav-button primary" id="save-event-btn">Save Event</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="encrypted-storage.js"></script>
    <script>
        class CalendarApp {
            constructor() {
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.currentView = 'month';
                this.events = [];
                this.editingEvent = null;
                this.storage = null;
                
                this.init();
            }

            async init() {
                await this.initStorage();
                await this.loadEvents();
                this.setupEventListeners();
                this.render();
            }

            async initStorage() {
                try {
                    if (typeof EncryptedStorage !== 'undefined') {
                        this.storage = new EncryptedStorage();
                    } else {
                        this.storage = {
                            async saveEncrypted(key, data) {
                                localStorage.setItem(key, JSON.stringify(data));
                                return true;
                            },
                            async loadEncrypted(key) {
                                const data = localStorage.getItem(key);
                                return data ? JSON.parse(data) : null;
                            }
                        };
                    }
                } catch (error) {
                    console.error('Storage initialization failed:', error);
                }
            }

            async loadEvents() {
                try {
                    const savedEvents = await this.storage.loadEncrypted('calendar-data');
                    if (savedEvents && Array.isArray(savedEvents)) {
                        this.events = savedEvents.map(event => ({
                            ...event,
                            date: new Date(event.date)
                        }));
                    }
                } catch (error) {
                    console.error('Failed to load events:', error);
                }
            }

            async saveEvents() {
                try {
                    const eventsToSave = this.events.map(event => ({
                        ...event,
                        date: event.date.toISOString()
                    }));
                    await this.storage.saveEncrypted('calendar-data', eventsToSave);
                } catch (error) {
                    console.error('Failed to save events:', error);
                }
            }

            setupEventListeners() {
                // Navigation buttons
                document.getElementById('prev-period').addEventListener('click', () => this.navigatePrevious());
                document.getElementById('next-period').addEventListener('click', () => this.navigateNext());
                document.getElementById('today-btn').addEventListener('click', () => this.goToToday());
                
                // View buttons
                document.getElementById('month-view-btn').addEventListener('click', () => this.switchView('month'));
                document.getElementById('week-view-btn').addEventListener('click', () => this.switchView('week'));
                
                // Event modal
                document.getElementById('new-event-btn').addEventListener('click', () => this.openEventModal());
                document.getElementById('modal-close').addEventListener('click', () => this.closeEventModal());
                document.getElementById('cancel-btn').addEventListener('click', () => this.closeEventModal());
                document.getElementById('save-event-btn').addEventListener('click', () => this.saveEvent());
                document.getElementById('delete-event-btn').addEventListener('click', () => this.deleteEvent());
                
                // Modal overlay click to close
                document.getElementById('event-modal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.closeEventModal();
                    }
                });
                
                // Mini calendar navigation
                document.getElementById('mini-prev').addEventListener('click', () => this.navigateMiniCalendar(-1));
                document.getElementById('mini-next').addEventListener('click', () => this.navigateMiniCalendar(1));
                
                // Form submission
                document.getElementById('event-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveEvent();
                });
            }

            navigatePrevious() {
                if (this.currentView === 'month') {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                } else if (this.currentView === 'week') {
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                }
                this.render();
            }

            navigateNext() {
                if (this.currentView === 'month') {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                } else if (this.currentView === 'week') {
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                }
                this.render();
            }

            goToToday() {
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.render();
            }

            switchView(view) {
                this.currentView = view;
                
                // Update button states
                document.querySelectorAll('#month-view-btn, #week-view-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`${view}-view-btn`).classList.add('active');
                
                // Show/hide views
                document.getElementById('month-view').style.display = view === 'month' ? 'flex' : 'none';
                document.getElementById('week-view').style.display = view === 'week' ? 'flex' : 'none';
                
                this.render();
            }

            navigateMiniCalendar(direction) {
                this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                this.render();
            }

            render() {
                this.updateTitle();
                this.renderMiniCalendar();
                this.renderUpcomingEvents();
                
                if (this.currentView === 'month') {
                    this.renderMonthView();
                } else if (this.currentView === 'week') {
                    this.renderWeekView();
                }
            }

            updateTitle() {
                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                if (this.currentView === 'month') {
                    document.getElementById('calendar-title').textContent = 
                        `${months[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                } else if (this.currentView === 'week') {
                    const startOfWeek = new Date(this.currentDate);
                    startOfWeek.setDate(this.currentDate.getDate() - this.currentDate.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    
                    document.getElementById('calendar-title').textContent = 
                        `${startOfWeek.getMonth() === endOfWeek.getMonth() ? 
                            months[startOfWeek.getMonth()] : 
                            months[startOfWeek.getMonth()] + ' - ' + months[endOfWeek.getMonth()]
                        } ${startOfWeek.getFullYear()}`;
                }
            }

            renderMiniCalendar() {
                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                document.getElementById('mini-month-title').textContent = 
                    `${months[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                
                const grid = document.getElementById('mini-calendar-grid');
                grid.innerHTML = '';
                
                // Day headers
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'mini-day day-header';
                    header.textContent = day;
                    header.style.fontWeight = '600';
                    header.style.color = 'var(--text-secondary)';
                    grid.appendChild(header);
                });
                
                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const today = new Date();
                
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    
                    const day = document.createElement('div');
                    day.className = 'mini-day';
                    day.textContent = cellDate.getDate();
                    
                    if (cellDate.getMonth() !== this.currentDate.getMonth()) {
                        day.classList.add('other-month');
                    }
                    
                    if (this.isSameDay(cellDate, today)) {
                        day.classList.add('today');
                    }
                    
                    day.addEventListener('click', () => {
                        this.selectedDate = new Date(cellDate);
                        if (cellDate.getMonth() !== this.currentDate.getMonth()) {
                            this.currentDate = new Date(cellDate);
                        }
                        this.render();
                    });
                    
                    grid.appendChild(day);
                }
            }

            renderMonthView() {
                const grid = document.getElementById('month-grid');
                grid.innerHTML = '';
                
                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const today = new Date();
                
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    if (cellDate.getMonth() !== this.currentDate.getMonth()) {
                        dayCell.classList.add('other-month');
                    }
                    
                    if (this.isSameDay(cellDate, today)) {
                        dayCell.classList.add('today');
                    }
                    
                    if (this.isSameDay(cellDate, this.selectedDate)) {
                        dayCell.classList.add('selected');
                    }
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = cellDate.getDate();
                    dayCell.appendChild(dayNumber);
                    
                    const dayEvents = document.createElement('div');
                    dayEvents.className = 'day-events';
                    
                    // Add events for this day
                    const dayEventList = this.getEventsForDate(cellDate);
                    dayEventList.slice(0, 3).forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = `event-item priority-${event.priority}`;
                        eventElement.textContent = event.title;
                        eventElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.editEvent(event);
                        });
                        dayEvents.appendChild(eventElement);
                    });
                    
                    if (dayEventList.length > 3) {
                        const moreElement = document.createElement('div');
                        moreElement.className = 'event-item';
                        moreElement.textContent = `+${dayEventList.length - 3} more`;
                        moreElement.style.background = 'var(--text-muted)';
                        moreElement.style.color = 'white';
                        dayEvents.appendChild(moreElement);
                    }
                    
                    dayCell.appendChild(dayEvents);
                    
                    dayCell.addEventListener('click', () => {
                        this.selectedDate = new Date(cellDate);
                        this.openEventModal(cellDate);
                    });
                    
                    grid.appendChild(dayCell);
                }
            }

            renderWeekView() {
                const weekHeader = document.getElementById('week-header');
                const weekGrid = document.getElementById('week-grid');
                
                // Clear existing content
                weekHeader.innerHTML = '<div class="time-label"></div>';
                weekGrid.innerHTML = '';
                
                // Get start of week (Sunday)
                const startOfWeek = new Date(this.currentDate);
                startOfWeek.setDate(this.currentDate.getDate() - this.currentDate.getDay());
                
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const today = new Date();
                
                // Create day headers
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + i);
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'week-day-header';
                    dayHeader.innerHTML = `${days[i]}<br><span style="font-size: 0.75rem;">${dayDate.getDate()}</span>`;
                    
                    if (this.isSameDay(dayDate, today)) {
                        dayHeader.style.background = 'var(--primary-color)';
                        dayHeader.style.color = 'white';
                    }
                    
                    weekHeader.appendChild(dayHeader);
                }
                
                // Create time slots (6 AM to 11 PM)
                for (let hour = 6; hour <= 23; hour++) {
                    // Hour label
                    const hourLabel = document.createElement('div');
                    hourLabel.className = 'hour-label';
                    hourLabel.textContent = this.formatHour(hour);
                    weekGrid.appendChild(hourLabel);
                    
                    // Hour slots for each day
                    for (let day = 0; day < 7; day++) {
                        const slotDate = new Date(startOfWeek);
                        slotDate.setDate(startOfWeek.getDate() + day);
                        slotDate.setHours(hour, 0, 0, 0);
                        
                        const hourSlot = document.createElement('div');
                        hourSlot.className = 'hour-slot';
                        
                        // Check for events at this time
                        const hourEvents = this.getEventsForDateTime(slotDate);
                        hourEvents.forEach(event => {
                            const eventElement = document.createElement('div');
                            eventElement.className = `event-item priority-${event.priority}`;
                            eventElement.textContent = event.title;
                            eventElement.style.position = 'absolute';
                            eventElement.style.left = '2px';
                            eventElement.style.right = '2px';
                            eventElement.style.zIndex = '1';
                            eventElement.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.editEvent(event);
                            });
                            hourSlot.appendChild(eventElement);
                        });
                        
                        hourSlot.addEventListener('click', () => {
                            this.openEventModal(slotDate);
                        });
                        
                        weekGrid.appendChild(hourSlot);
                    }
                }
            }

            renderUpcomingEvents() {
                const container = document.getElementById('upcoming-events');
                container.innerHTML = '';
                
                const upcomingEvents = this.events
                    .filter(event => event.date >= new Date())
                    .sort((a, b) => a.date - b.date)
                    .slice(0, 10);
                
                if (upcomingEvents.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size: var(--font-size-sm);">No upcoming events</p>';
                    return;
                }
                
                upcomingEvents.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.className = 'event-list-item';
                    
                    const colorDot = document.createElement('div');
                    colorDot.className = 'event-color';
                    colorDot.style.background = this.getPriorityColor(event.priority);
                    
                    const eventDetails = document.createElement('div');
                    eventDetails.className = 'event-details';
                    
                    const eventTitle = document.createElement('div');
                    eventTitle.className = 'event-title';
                    eventTitle.textContent = event.title;
                    
                    const eventTime = document.createElement('div');
                    eventTime.className = 'event-time';
                    eventTime.textContent = this.formatEventDateTime(event.date);
                    
                    eventDetails.appendChild(eventTitle);
                    eventDetails.appendChild(eventTime);
                    
                    eventItem.appendChild(colorDot);
                    eventItem.appendChild(eventDetails);
                    
                    eventItem.addEventListener('click', () => {
                        this.editEvent(event);
                    });
                    
                    container.appendChild(eventItem);
                });
            }

            openEventModal(date = null) {
                this.editingEvent = null;
                document.getElementById('modal-title').textContent = 'New Event';
                document.getElementById('delete-event-btn').classList.add('hidden');
                
                // Reset form
                document.getElementById('event-form').reset();
                
                if (date) {
                    document.getElementById('event-date').value = this.formatDateForInput(date);
                    if (date.getHours() !== 0) {
                        document.getElementById('event-time').value = this.formatTimeForInput(date);
                    }
                } else {
                    document.getElementById('event-date').value = this.formatDateForInput(this.selectedDate);
                }
                
                document.getElementById('event-modal').style.display = 'flex';
                document.getElementById('event-title').focus();
            }

            editEvent(event) {
                this.editingEvent = event;
                document.getElementById('modal-title').textContent = 'Edit Event';
                document.getElementById('delete-event-btn').classList.remove('hidden');
                
                // Populate form
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-description').value = event.description || '';
                document.getElementById('event-date').value = this.formatDateForInput(event.date);
                document.getElementById('event-time').value = event.time || '';
                document.getElementById('event-priority').value = event.priority;
                document.getElementById('event-category').value = event.category;
                document.getElementById('event-reminder').value = event.reminder || 'none';
                
                document.getElementById('event-modal').style.display = 'flex';
                document.getElementById('event-title').focus();
            }

            closeEventModal() {
                document.getElementById('event-modal').style.display = 'none';
                this.editingEvent = null;
            }

            async saveEvent() {
                const title = document.getElementById('event-title').value.trim();
                const description = document.getElementById('event-description').value.trim();
                const date = document.getElementById('event-date').value;
                const time = document.getElementById('event-time').value;
                const priority = document.getElementById('event-priority').value;
                const category = document.getElementById('event-category').value;
                const reminder = document.getElementById('event-reminder').value;
                
                if (!title || !date) {
                    alert('Please fill in the required fields (Title and Date).');
                    return;
                }
                
                const eventDate = new Date(date);
                if (time) {
                    const [hours, minutes] = time.split(':');
                    eventDate.setHours(parseInt(hours), parseInt(minutes));
                }
                
                const eventData = {
                    id: this.editingEvent ? this.editingEvent.id : Date.now().toString(),
                    title,
                    description,
                    date: eventDate,
                    time,
                    priority,
                    category,
                    reminder
                };
                
                if (this.editingEvent) {
                    // Update existing event
                    const index = this.events.findIndex(e => e.id === this.editingEvent.id);
                    if (index !== -1) {
                        this.events[index] = eventData;
                    }
                } else {
                    // Add new event
                    this.events.push(eventData);
                }
                
                await this.saveEvents();
                this.closeEventModal();
                this.render();
            }

            async deleteEvent() {
                if (!this.editingEvent) return;
                
                if (confirm('Are you sure you want to delete this event?')) {
                    this.events = this.events.filter(e => e.id !== this.editingEvent.id);
                    await this.saveEvents();
                    this.closeEventModal();
                    this.render();
                }
            }

            // Utility methods
            isSameDay(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }

            getEventsForDate(date) {
                return this.events.filter(event => this.isSameDay(event.date, date));
            }

            getEventsForDateTime(dateTime) {
                return this.events.filter(event => 
                    this.isSameDay(event.date, dateTime) && 
                    event.date.getHours() === dateTime.getHours()
                );
            }

            formatDateForInput(date) {
                return date.toISOString().split('T')[0];
            }

            formatTimeForInput(date) {
                return date.toTimeString().slice(0, 5);
            }

            formatHour(hour) {
                return hour < 12 ? `${hour === 0 ? 12 : hour} AM` : 
                       `${hour === 12 ? 12 : hour - 12} PM`;
            }

            formatEventDateTime(date) {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                
                if (this.isSameDay(date, today)) {
                    return `Today ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                } else if (this.isSameDay(date, tomorrow)) {
                    return `Tomorrow ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                } else {
                    return date.toLocaleDateString([], {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }

            getPriorityColor(priority) {
                switch (priority) {
                    case 'high': return 'var(--danger-color)';
                    case 'medium': return 'var(--accent-color)';
                    case 'low': return 'var(--secondary-color)';
                    default: return 'var(--text-muted)';
                }
            }
        }

        // Initialize the calendar app
        let calendarApp;
        document.addEventListener('DOMContentLoaded', () => {
            calendarApp = new CalendarApp();
        });

        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            if (event.data && event.data.action === 'refresh-calendar') {
                if (calendarApp) {
                    calendarApp.loadEvents().then(() => {
                        calendarApp.render();
                    });
                }
            }
        });
    </script>
</body>
</html>
