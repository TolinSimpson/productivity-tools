<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Settings</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; }
        .settings-section { 
            background: white; 
            margin-bottom: 15px; 
            padding: 15px; 
            border-radius: 5px; 
            border: 1px solid #ddd; 
        }
        .settings-section h3 { 
            margin: 0 0 15px 0; 
            color: #333; 
            font-size: 1.1rem; 
        }
        .setting-item { 
            margin-bottom: 15px; 
            padding: 10px; 
            border: 1px solid #eee; 
            border-radius: 3px; 
            background: #f9f9f9; 
        }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-item label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #333; 
        }
        .setting-description { 
            color: #666; 
            font-size: 0.9rem; 
            margin-bottom: 10px; 
        }
        .setting-buttons { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
        }
        .btn { 
            padding: 6px 12px; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            background: #fff; 
            cursor: pointer; 
            font-size: 0.9rem; 
        }
        .btn:hover { background: #f0f0f0; }
        .btn-primary { background: #007bff; color: white; border-color: #007bff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; border-color: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .btn-danger { background: #dc3545; color: white; border-color: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .storage-info { 
            background: #f8f9fa; 
            padding: 8px; 
            border-radius: 3px; 
            border: 1px solid #e9ecef; 
        }
        .info-item { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 4px; 
        }
        .info-item:last-child { margin-bottom: 0; }
        .info-label { color: #666; }
        .info-value { font-weight: bold; }
        .app-info { 
            text-align: center; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef; 
        }
        .app-info h4 { 
            margin-bottom: 8px; 
            color: #333; 
            font-size: 1.2rem; 
        }
        .app-info p { 
            margin-bottom: 4px; 
            color: #666; 
        }
    </style>
    <script src="encrypted-storage.js"></script>
</head>
<body>
    <div class="container">
        <!-- Security Section -->
        <div class="settings-section">
            <h3>üîí Security & Privacy</h3>
            <div class="setting-item">
                <label>Password Protection</label>
                <p class="setting-description">Protect your notes with a password. When enabled, you'll need to enter your password to view or edit notes.</p>
                <div class="storage-info" id="password-status">
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="password-enabled-status">Loading...</span>
                    </div>
                </div>
                <div class="setting-buttons" id="password-controls">
                    <button id="enable-password-btn" class="btn btn-primary" style="display: none;">üîí Enable Password Protection</button>
                    <button id="change-password-btn" class="btn btn-secondary" style="display: none;">üîë Change Password</button>
                    <button id="disable-password-btn" class="btn btn-danger" style="display: none;">üîì Disable Password Protection</button>
                </div>
            </div>
        </div>

        <!-- Data Management Section -->
        <div class="settings-section">
            <h3>üíæ Data Management</h3>
            <div class="setting-item">
                <label>Backup & Restore</label>
                <p class="setting-description">Export and import all your productivity data from all tools</p>
                <div class="setting-buttons">
                    <button id="export-btn" class="btn btn-secondary">üì§ Export All Data</button>
                    <button id="import-btn" class="btn btn-secondary">üì• Import Data</button>
                    <button id="preview-btn" class="btn btn-secondary">üëÄ Preview Data</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Clear All Data</label>
                <p class="setting-description">Permanently delete all stored data from all productivity tools</p>
                <div class="setting-buttons">
                    <button id="clear-btn" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Storage Status</label>
                <p class="setting-description">Current data storage information</p>
                <div class="storage-info" id="storage-info">
                    <div class="info-item">
                        <span class="info-label">Tools with data:</span>
                        <span class="info-value" id="tools-count">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Storage type:</span>
                        <span class="info-value" id="storage-type">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Auto-save:</span>
                        <span class="info-value">Enabled</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- PWA Features Section -->
        <div class="settings-section">
            <h3>üì± Progressive Web App</h3>
            <div class="setting-item" id="install-item">
                <label>Installation</label>
                <p class="setting-description">Install this app on your device for offline access and better performance</p>
                <div class="setting-buttons" id="install-section">
                    <span id="install-status">Checking installation status...</span>
                    <button id="install-btn" class="btn btn-primary" style="display: none;">üì± Install App</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Offline Support</label>
                <p class="setting-description">This app works completely offline after installation</p>
                <div class="storage-info">
                    <div class="info-item">
                        <span class="info-label">Service Worker:</span>
                        <span class="info-value" id="sw-status">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cache Status:</span>
                        <span class="info-value" id="cache-status">Loading...</span>
                    </div>
                </div>
            </div>
        </div>



        <!-- App Information Footer -->
        <div class="app-info">
            <h4>üìù Productivity Suite</h4>
            <p>&copy; 2025 Tolin Simpson</p>
            <p class="version-info" id="version-info">Version loading...</p>
            <script>
                // Fetch version from manifest.json and update the version-info element
                fetch('manifest.json')
                    .then(response => response.json())
                    .then(manifest => {
                        const version = manifest.version || 'Unknown';
                        document.getElementById('version-info').textContent = `Version ${version}`;
                    })
                    .catch(() => {
                        document.getElementById('version-info').textContent = 'Version unavailable';
                    });
            </script>
        </div>
    </div>

    <!-- Password Setup Modal -->
    <div id="passwordSetupModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="passwordModalTitle">üîí Set Password</h3>
            </div>
            <div class="modal-body">
                <p id="passwordModalMessage">Enter a password to protect your notes:</p>
                <input type="password" id="newPasswordInput" class="password-input" placeholder="Enter new password..." autocomplete="new-password">
                <input type="password" id="confirmPasswordInput" class="password-input" placeholder="Confirm password..." autocomplete="new-password">
                <input type="password" id="currentPasswordInput" class="password-input" placeholder="Enter current password..." autocomplete="current-password" style="display: none;">
                <div id="passwordSetupError" class="error-message" style="display: none;">
                    Passwords do not match or other error.
                </div>
            </div>
            <div class="modal-footer">
                <button id="passwordSetupCancel" class="btn btn-secondary">Cancel</button>
                <button id="passwordSetupConfirm" class="btn btn-primary">üîí Set Password</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
            width: 90vw;
            margin: 20px;
            box-sizing: border-box;
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #1e293b;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-body p {
            margin: 0 0 16px 0;
            color: #64748b;
            line-height: 1.5;
        }
        .password-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            margin-bottom: 12px;
            box-sizing: border-box;
            max-width: 100%;
        }
        .password-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 8px;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
    </style>

    <script>
        let storage = null;

        // Initialize storage
        async function initStorage() {
            try {
                if (typeof EncryptedStorage !== 'undefined') {
                    storage = new EncryptedStorage();
                } else {
                    // Fallback storage
                    storage = {
                        async saveEncrypted(key, data) {
                            localStorage.setItem(key, JSON.stringify(data));
                            return true;
                        },
                        async loadEncrypted(key) {
                            const data = localStorage.getItem(key);
                            return data ? JSON.parse(data) : null;
                        },
                        async clearAll() {
                            localStorage.clear();
                            return true;
                        }
                    };
                }
                updateStorageDisplay();
            } catch (error) {
                console.error('Storage initialization failed:', error);
            }
        }

        async function updateStorageDisplay() {
            // Update tools count
            const toolKeys = ['notebook-data', 'pomodoro-data', 'checklist-data', 'eisenhower-data'];
            let toolsWithData = 0;
            
            for (const key of toolKeys) {
                try {
                    const data = await storage.loadEncrypted(key);
                    if (data) toolsWithData++;
                } catch (error) {
                    console.error(`Error checking ${key}:`, error);
                }
            }
            
            document.getElementById('tools-count').textContent = `${toolsWithData} of 4 tools`;
            
            // Update storage type
            const hasEncryption = typeof EncryptedStorage !== 'undefined';
            document.getElementById('storage-type').textContent = hasEncryption ? 'Encrypted Local Storage' : 'Local Storage (Fallback)';
            
            // Update password protection status
            await updatePasswordStatus();
            
            // Update PWA status
            updatePWAStatus();
        }

        async function updatePasswordStatus() {
            try {
                const notebookData = await storage.loadEncrypted('notebook-data');
                const isPasswordEnabled = notebookData?.settings?.passwordProtected || false;
                
                const statusElement = document.getElementById('password-enabled-status');
                const enableBtn = document.getElementById('enable-password-btn');
                const changeBtn = document.getElementById('change-password-btn');
                const disableBtn = document.getElementById('disable-password-btn');
                
                if (isPasswordEnabled) {
                    statusElement.textContent = 'üîí Enabled';
                    statusElement.style.color = '#059669';
                    enableBtn.style.display = 'none';
                    changeBtn.style.display = 'inline-block';
                    disableBtn.style.display = 'inline-block';
                } else {
                    statusElement.textContent = 'üîì Disabled';
                    statusElement.style.color = '#dc2626';
                    enableBtn.style.display = 'inline-block';
                    changeBtn.style.display = 'none';
                    disableBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking password status:', error);
                document.getElementById('password-enabled-status').textContent = 'Error';
            }
        }

        function updatePWAStatus() {
            // Check if app is installed or running locally
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.protocol === 'file:';
            
            const installStatus = document.getElementById('install-status');
            const installBtn = document.getElementById('install-btn');
            const installItem = document.getElementById('install-item');
            
            if (isLocalhost) {
                // Hide entire install section when running locally
                installItem.style.display = 'none';
            } else if (isInstalled) {
                installStatus.textContent = '‚úÖ App is installed';
                installBtn.style.display = 'none';
            } else {
                installStatus.textContent = 'üì± App can be installed';
                installBtn.style.display = 'inline-block';
            }
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    const swStatus = document.getElementById('sw-status');
                    const cacheStatus = document.getElementById('cache-status');
                    
                    if (registration) {
                        swStatus.textContent = '‚úÖ Active';
                        cacheStatus.textContent = '‚úÖ Available';
                    } else {
                        swStatus.textContent = '‚ùå Not registered';
                        cacheStatus.textContent = '‚ùå Not available';
                    }
                });
            } else {
                document.getElementById('sw-status').textContent = '‚ùå Not supported';
                document.getElementById('cache-status').textContent = '‚ùå Not available';
            }
        }

        async function exportAllData() {
            try {
                const allData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    app: 'Productivity Suite',
                    tools: {}
                };

                // Export data from all tools
                const toolKeys = [
                    { key: 'notebook-data', name: 'notebook' },
                    { key: 'pomodoro-data', name: 'pomodoro' },
                    { key: 'checklist-data', name: 'checklist' },
                    { key: 'eisenhower-data', name: 'eisenhower' }
                ];

                for (const {key, name} of toolKeys) {
                    try {
                        const data = await storage.loadEncrypted(key);
                        if (data) {
                            allData.tools[name] = data;
                        }
                    } catch (error) {
                        console.error(`Error exporting ${name}:`, error);
                    }
                }

                // Create and download file
                const blob = new Blob([JSON.stringify(allData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `productivity-suite-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚úÖ All data exported successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                alert('‚ùå Export failed: ' + error.message);
            }
        }

        async function importAllData() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);

                        if (!data.tools) {
                            throw new Error('Invalid backup file format');
                        }

                        // Import data to all tools
                        const toolKeys = [
                            { key: 'notebook-data', name: 'notebook' },
                            { key: 'pomodoro-data', name: 'pomodoro' },
                            { key: 'checklist-data', name: 'checklist' },
                            { key: 'eisenhower-data', name: 'eisenhower' }
                        ];

                        let importedCount = 0;
                        for (const {key, name} of toolKeys) {
                            if (data.tools[name]) {
                                try {
                                    await storage.saveEncrypted(key, data.tools[name]);
                                    importedCount++;
                                } catch (error) {
                                    console.error(`Error importing ${name}:`, error);
                                }
                            }
                        }

                        alert(`‚úÖ Data imported successfully!\n${importedCount} tools updated.\nPlease refresh to see changes.`);
                        updateStorageDisplay();
                    } catch (error) {
                        console.error('Import failed:', error);
                        alert('‚ùå Import failed: ' + error.message);
                    }
                };

                fileInput.click();
            } catch (error) {
                console.error('Import setup failed:', error);
                alert('‚ùå Import setup failed: ' + error.message);
            }
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear ALL data?\n\nThis will permanently delete:\n- All notebook notes\n- Pomodoro session history\n- All checklist tasks\n- Eisenhower matrix tasks\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                // Clear data from all tools
                const toolKeys = ['notebook-data', 'pomodoro-data', 'checklist-data', 'eisenhower-data'];
                
                for (const key of toolKeys) {
                    try {
                        localStorage.removeItem(key);
                    } catch (error) {
                        console.error(`Error clearing ${key}:`, error);
                    }
                }

                // Clear any additional storage
                if (storage && storage.clearAll) {
                    await storage.clearAll();
                }

                alert('‚úÖ All data cleared successfully!\nThe page will now reload.');
                updateStorageDisplay();
                
                // Reload page after delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                console.error('Clear failed:', error);
                alert('‚ùå Clear failed: ' + error.message);
            }
        }

        function installApp() {
            if (window.parent && window.parent !== window) {
                // We're in an iframe, send message to parent
                window.parent.postMessage({ action: 'install-app' }, '*');
            } else {
                alert('App installation is handled by the main application.');
            }
        }

        async function previewData() {
            try {
                const toolKeys = [
                    { key: 'notebook-data', name: 'Notebook' },
                    { key: 'pomodoro-data', name: 'Pomodoro' },
                    { key: 'checklist-data', name: 'Checklist' },
                    { key: 'eisenhower-data', name: 'Eisenhower' }
                ];

                let preview = 'üìä Data Overview:\n\n';
                let totalSize = 0;

                for (const {key, name} of toolKeys) {
                    try {
                        const data = await storage.loadEncrypted(key);
                        if (data) {
                            const size = JSON.stringify(data).length;
                            totalSize += size;
                            preview += `${name}: ${(size / 1024).toFixed(1)} KB\n`;
                            
                            // Add specific data counts
                            if (name === 'Notebook' && data.notes) {
                                preview += `  - ${data.notes.length} notes\n`;
                            } else if (name === 'Pomodoro' && data.sessions) {
                                preview += `  - ${data.sessions.length} sessions\n`;
                            } else if (name === 'Checklist' && data.projects) {
                                preview += `  - ${data.projects.length} projects\n`;
                            } else if (name === 'Eisenhower' && data.tasks) {
                                preview += `  - ${data.tasks.length} tasks\n`;
                            }
                        } else {
                            preview += `${name}: No data\n`;
                        }
                    } catch (error) {
                        preview += `${name}: Error reading data\n`;
                    }
                }

                preview += `\nTotal size: ${(totalSize / 1024).toFixed(1)} KB`;
                alert(preview);
            } catch (error) {
                console.error('Preview failed:', error);
                alert('‚ùå Preview failed: ' + error.message);
            }
        }

        // Password management functions
        async function hashPassword(password) {
            // Simple hash function for demo - in production, use stronger hashing
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'notes-salt-2025');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function verifyPassword(inputPassword, storedHash) {
            const inputHash = await hashPassword(inputPassword);
            return inputHash === storedHash;
        }

        function showPasswordModal(mode, currentHash = null) {
            const modal = document.getElementById('passwordSetupModal');
            const title = document.getElementById('passwordModalTitle');
            const message = document.getElementById('passwordModalMessage');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const currentPasswordInput = document.getElementById('currentPasswordInput');
            const confirmBtn = document.getElementById('passwordSetupConfirm');
            const errorDiv = document.getElementById('passwordSetupError');

            // Reset form
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            currentPasswordInput.value = '';
            errorDiv.style.display = 'none';

            if (mode === 'enable') {
                title.textContent = 'üîí Enable Password Protection';
                message.textContent = 'Set a password to protect your notes:';
                currentPasswordInput.style.display = 'none';
                confirmBtn.textContent = 'üîí Enable Protection';
            } else if (mode === 'change') {
                title.textContent = 'üîë Change Password';
                message.textContent = 'Enter your current password and a new password:';
                currentPasswordInput.style.display = 'block';
                confirmBtn.textContent = 'üîë Change Password';
            } else if (mode === 'disable') {
                title.textContent = 'üîì Disable Password Protection';
                message.textContent = 'Enter your current password to disable protection:';
                newPasswordInput.style.display = 'none';
                confirmPasswordInput.style.display = 'none';
                currentPasswordInput.style.display = 'block';
                confirmBtn.textContent = 'üîì Disable Protection';
            }

            // Ensure proper display for enable mode
            if (mode === 'enable') {
                newPasswordInput.style.display = 'block';
                confirmPasswordInput.style.display = 'block';
            } else if (mode === 'change') {
                newPasswordInput.style.display = 'block';
                confirmPasswordInput.style.display = 'block';
            }

            modal.style.display = 'flex';
            setTimeout(() => {
                if (mode === 'disable' || mode === 'change') {
                    currentPasswordInput.focus();
                } else {
                    newPasswordInput.focus();
                }
            }, 100);

            return new Promise((resolve) => {
                const handleConfirm = async () => {
                    try {
                        if (mode === 'enable') {
                            const newPassword = newPasswordInput.value;
                            const confirmPassword = confirmPasswordInput.value;

                            if (!newPassword || newPassword.length < 4) {
                                showError('Password must be at least 4 characters long.');
                                return;
                            }

                            if (newPassword !== confirmPassword) {
                                showError('Passwords do not match.');
                                return;
                            }

                            const passwordHash = await hashPassword(newPassword);
                            hidePasswordModal();
                            resolve({ success: true, hash: passwordHash });

                        } else if (mode === 'change') {
                            const currentPassword = currentPasswordInput.value;
                            const newPassword = newPasswordInput.value;
                            const confirmPassword = confirmPasswordInput.value;

                            if (!await verifyPassword(currentPassword, currentHash)) {
                                showError('Current password is incorrect.');
                                return;
                            }

                            if (!newPassword || newPassword.length < 4) {
                                showError('New password must be at least 4 characters long.');
                                return;
                            }

                            if (newPassword !== confirmPassword) {
                                showError('New passwords do not match.');
                                return;
                            }

                            const passwordHash = await hashPassword(newPassword);
                            hidePasswordModal();
                            resolve({ success: true, hash: passwordHash });

                        } else if (mode === 'disable') {
                            const currentPassword = currentPasswordInput.value;

                            if (!await verifyPassword(currentPassword, currentHash)) {
                                showError('Password is incorrect.');
                                return;
                            }

                            hidePasswordModal();
                            resolve({ success: true });
                        }
                    } catch (error) {
                        showError('An error occurred. Please try again.');
                        console.error('Password operation error:', error);
                    }
                };

                const handleCancel = () => {
                    hidePasswordModal();
                    resolve({ success: false });
                };

                const showError = (message) => {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                };

                // Set up event listeners
                document.getElementById('passwordSetupConfirm').onclick = handleConfirm;
                document.getElementById('passwordSetupCancel').onclick = handleCancel;

                // Handle Enter key
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') handleConfirm();
                    if (e.key === 'Escape') handleCancel();
                };

                newPasswordInput.onkeypress = handleKeyPress;
                confirmPasswordInput.onkeypress = handleKeyPress;
                currentPasswordInput.onkeypress = handleKeyPress;
            });
        }

        function hidePasswordModal() {
            document.getElementById('passwordSetupModal').style.display = 'none';
            // Clean up event listeners
            document.getElementById('passwordSetupConfirm').onclick = null;
            document.getElementById('passwordSetupCancel').onclick = null;
            document.getElementById('newPasswordInput').onkeypress = null;
            document.getElementById('confirmPasswordInput').onkeypress = null;
            document.getElementById('currentPasswordInput').onkeypress = null;
        }

        async function enablePasswordProtection() {
            const result = await showPasswordModal('enable');
            if (!result.success) return;

            try {
                const notebookData = await storage.loadEncrypted('notebook-data') || {};
                notebookData.settings = notebookData.settings || {};
                notebookData.settings.passwordProtected = true;
                notebookData.settings.passwordHash = result.hash;

                await storage.saveEncrypted('notebook-data', notebookData);
                await updatePasswordStatus();
                
                // Notify notes list of changes
                notifyPasswordSettingsChanged();
                
                alert('‚úÖ Password protection enabled!\nYour notes are now secured with a password.');
            } catch (error) {
                console.error('Failed to enable password protection:', error);
                alert('‚ùå Failed to enable password protection: ' + error.message);
            }
        }

        async function changePassword() {
            try {
                const notebookData = await storage.loadEncrypted('notebook-data');
                const currentHash = notebookData?.settings?.passwordHash;
                
                if (!currentHash) {
                    alert('‚ùå No password is currently set.');
                    return;
                }

                const result = await showPasswordModal('change', currentHash);
                if (!result.success) return;

                notebookData.settings.passwordHash = result.hash;
                await storage.saveEncrypted('notebook-data', notebookData);
                await updatePasswordStatus();
                
                // Notify notes list of changes
                notifyPasswordSettingsChanged();
                
                alert('‚úÖ Password changed successfully!');
            } catch (error) {
                console.error('Failed to change password:', error);
                alert('‚ùå Failed to change password: ' + error.message);
            }
        }

        async function disablePasswordProtection() {
            try {
                const notebookData = await storage.loadEncrypted('notebook-data');
                const currentHash = notebookData?.settings?.passwordHash;
                
                if (!currentHash) {
                    alert('‚ùå Password protection is not currently enabled.');
                    return;
                }

                const result = await showPasswordModal('disable', currentHash);
                if (!result.success) return;

                notebookData.settings.passwordProtected = false;
                notebookData.settings.passwordHash = null;
                await storage.saveEncrypted('notebook-data', notebookData);
                await updatePasswordStatus();
                
                // Notify notes list of changes
                notifyPasswordSettingsChanged();
                
                alert('‚úÖ Password protection disabled!\nYour notes are no longer password protected.');
            } catch (error) {
                console.error('Failed to disable password protection:', error);
                alert('‚ùå Failed to disable password protection: ' + error.message);
            }
        }

        function notifyPasswordSettingsChanged() {
            // Try to notify the notes list if it's in an iframe
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'password-settings-changed' }, '*');
            }
            
            // Also try to find and notify any iframe containing notes-list
            const frames = document.querySelectorAll('iframe');
            frames.forEach(frame => {
                try {
                    frame.contentWindow.postMessage({ action: 'password-settings-changed' }, '*');
                } catch (error) {
                    // Ignore cross-origin errors
                }
            });

            // Send a broadcast message to all windows/tabs
            try {
                localStorage.setItem('password-settings-changed', Date.now().toString());
                localStorage.removeItem('password-settings-changed');
            } catch (error) {
                // Ignore localStorage errors
            }
        }

        // Event listeners
        document.getElementById('enable-password-btn').addEventListener('click', enablePasswordProtection);
        document.getElementById('change-password-btn').addEventListener('click', changePassword);
        document.getElementById('disable-password-btn').addEventListener('click', disablePasswordProtection);
        document.getElementById('export-btn').addEventListener('click', exportAllData);
        document.getElementById('import-btn').addEventListener('click', importAllData);
        document.getElementById('preview-btn').addEventListener('click', previewData);
        document.getElementById('clear-btn').addEventListener('click', clearAllData);
        document.getElementById('install-btn').addEventListener('click', installApp);

        // Initialize when page loads
        window.addEventListener('load', async () => {
            await initStorage();
        });
    </script>
</body>
</html>
