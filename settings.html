<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Settings</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            background: #f5f5f5; 
        }
        .container { max-width: 600px; margin: 0 auto; }
        .settings-section { 
            background: white; 
            margin-bottom: 15px; 
            padding: 15px; 
            border-radius: 5px; 
            border: 1px solid #ddd; 
        }
        .settings-section h3 { 
            margin: 0 0 15px 0; 
            color: #333; 
            font-size: 1.1rem; 
        }
        .setting-item { 
            margin-bottom: 15px; 
            padding: 10px; 
            border: 1px solid #eee; 
            border-radius: 3px; 
            background: #f9f9f9; 
        }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-item label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #333; 
        }
        .setting-description { 
            color: #666; 
            font-size: 0.9rem; 
            margin-bottom: 10px; 
        }
        .setting-buttons { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
        }
        .btn { 
            padding: 6px 12px; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            background: #fff; 
            cursor: pointer; 
            font-size: 0.9rem; 
        }
        .btn:hover { background: #f0f0f0; }
        .btn-primary { background: #007bff; color: white; border-color: #007bff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; border-color: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .btn-danger { background: #dc3545; color: white; border-color: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .storage-info { 
            background: #f8f9fa; 
            padding: 8px; 
            border-radius: 3px; 
            border: 1px solid #e9ecef; 
        }
        .info-item { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 4px; 
        }
        .info-item:last-child { margin-bottom: 0; }
        .info-label { color: #666; }
        .info-value { font-weight: bold; }
        .info-value.connected {
            color: #059669;
        }
        
        .info-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }
        
        .info-box ul, .info-box ol {
            margin: 0 0 12px 0;
            padding-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .info-box p {
            margin: 0;
            font-style: italic;
            color: #64748b;
        }
        .app-info { 
            text-align: center; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 5px; 
            border: 1px solid #e9ecef; 
        }
        .app-info h4 { 
            margin-bottom: 8px; 
            color: #333; 
            font-size: 1.2rem; 
        }
        .app-info p { 
            margin-bottom: 4px; 
            color: #666; 
        }
    </style>
    <script src="encrypted-storage.js"></script>
    <script src="cloud-auth.js"></script>
</head>
<body>
    <div class="container">
        <!-- Security Section -->
        <div class="settings-section">
            <h3>üîí Security & Privacy</h3>
            <div class="setting-item">
                <label>Password Protection</label>
                <p class="setting-description">Protect your notes with a password. When enabled, you'll need to enter your password to view or edit notes.</p>
                <div class="storage-info" id="password-status">
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="password-enabled-status">Loading...</span>
                    </div>
                </div>
                <div class="setting-buttons" id="password-controls">
                    <button id="enable-password-btn" class="btn btn-primary" style="display: none;">üîí Enable Password Protection</button>
                    <button id="change-password-btn" class="btn btn-secondary" style="display: none;">üîë Change Password</button>
                    <button id="disable-password-btn" class="btn btn-danger" style="display: none;">üîì Disable Password Protection</button>
                </div>
            </div>
        </div>

        <!-- PWA Features Section -->
        <div class="settings-section">
            <h3>üì± Progressive Web App</h3>
            <div class="setting-item" id="install-item">
                <label>Installation</label>
                <p class="setting-description">Install this app on your device for offline access and better performance</p>
                <div class="setting-buttons" id="install-section">
                    <span id="install-status">Checking installation status...</span>
                    <button id="install-btn" class="btn btn-primary" style="display: none;">üì± Install App</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Offline Support</label>
                <p class="setting-description">This app works completely offline after installation</p>
                <div class="storage-info">
                    <div class="info-item">
                        <span class="info-label">Service Worker:</span>
                        <span class="info-value" id="sw-status">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cache Status:</span>
                        <span class="info-value" id="cache-status">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Section -->
        <div class="settings-section">
            <h3>üíæ Data Management</h3>
            <div class="setting-item">
                <label>Backup & Restore</label>
                <p class="setting-description">Export and import all your productivity data from all tools</p>
                <div class="setting-buttons">
                    <button id="export-btn" class="btn btn-secondary">üì§ Export All Data</button>
                    <button id="import-btn" class="btn btn-secondary">üì• Import Data</button>
                    <button id="preview-btn" class="btn btn-secondary">üëÄ Preview Data</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Clear All Data</label>
                <p class="setting-description">Permanently delete all stored data from all productivity tools</p>
                <div class="setting-buttons">
                    <button id="clear-btn" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Storage Status</label>
                <p class="setting-description">Current data storage information</p>
                <div class="storage-info" id="storage-info">
                    <div class="info-item">
                        <span class="info-label">Tools with data:</span>
                        <span class="info-value" id="tools-count">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Storage type:</span>
                        <span class="info-value" id="storage-type">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Auto-save:</span>
                        <span class="info-value">Enabled</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloud Storage Section -->
        <div class="settings-section">
            <h3>‚òÅÔ∏è Cloud Storage & Sync</h3>
            <div class="setting-item">
                <label>Browser-Native Cloud Sync</label>
                <p class="setting-description">Save your data directly to cloud storage if signed into a provider such as Google Drive, OneDrive, or Dropbox.</p>
                <div class="storage-info" id="cloud-storage-status">
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="cloud-connection-status">Not connected</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Provider:</span>
                        <span class="info-value" id="cloud-provider-name">None</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last sync:</span>
                        <span class="info-value" id="cloud-last-sync">Never</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Auto-sync:</span>
                        <span class="info-value" id="cloud-auto-sync-status">Disabled</span>
                    </div>
                </div>
                <div class="setting-buttons" id="cloud-storage-controls">
                    <button id="connect-cloud-btn" class="btn btn-primary">üîó Connect to Cloud Storage</button>
                    <button id="disconnect-cloud-btn" class="btn btn-secondary" style="display: none;">üîó Disconnect</button>
                    <button id="sync-now-btn" class="btn btn-secondary" style="display: none;">üîÑ Sync Now</button>
                    <button id="toggle-auto-sync-btn" class="btn btn-secondary" style="display: none;">‚öôÔ∏è Auto-sync: OFF</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Sync Settings</label>
                <p class="setting-description">Connect to cloud storage to configure sync behavior and security</p>
                <div class="sync-options" id="sync-options" style="display: none;">
                    <div class="sync-option">
                        <input type="checkbox" id="sync-all-data" checked disabled>
                        <label for="sync-all-data">üì¶ Sync complete data export</label>
                    </div>
                    <div class="sync-option">
                        <input type="checkbox" id="encrypt-before-sync" checked>
                        <label for="encrypt-before-sync">üîí Always encrypt data before syncing to cloud</label>
                    </div>
                    <div class="sync-option">
                        <input type="checkbox" id="sync-when-offline" checked>
                        <label for="sync-when-offline">üîÑ Sync when offline/local (queue for next connection)</label>
                    </div>
                    <div class="sync-frequency">
                        <label for="sync-frequency-select">Sync frequency:</label>
                        <select id="sync-frequency-select">
                            <option value="5">Every 5 minutes</option>
                            <option value="15" selected>Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every hour</option>
                            <option value="0">Manual only (no auto-sync)</option>
                        </select>
                    </div>
                    <div class="sync-status-info">
                        <small>üí° <strong>Current Status:</strong> <span id="current-sync-status">Checking...</span></small>
                    </div>
                </div>
            </div>
            <div class="setting-item">
        </div>

        <!-- App Information Footer -->
        <div class="app-info">
            <h4>üìù Productivity Suite</h4>
            <p>&copy; 2025 Tolin Simpson</p>
            <p class="version-info" id="version-info">Version loading...</p>
            <div class="app-update-section">
                <button id="check-update-btn" class="btn btn-secondary" style="margin-top: 10px;">
                    üîÑ Check for Updates
                </button>
                <p class="update-status" id="update-status" style="font-size: 0.9em; margin-top: 5px; color: #666;"></p>
            </div>
            <script>
                // Try to fetch version from manifest.json, with CORS-safe fallback
                async function loadVersion() {
                    try {
                        // Check if we're on a local file system or server
                        if (window.location.protocol === 'file:') {
                            // For local files, use a hardcoded version to avoid CORS
                            document.getElementById('version-info').textContent = 'Version 1.0.0 (Local Development)';
                            return;
                        }
                        
                        const response = await fetch('manifest.json');
                        if (response.ok) {
                            const manifest = await response.json();
                            const version = manifest.version || 'Unknown';
                            document.getElementById('version-info').textContent = `Version ${version}`;
                        } else {
                            throw new Error('Manifest not accessible');
                        }
                    } catch (error) {
                        // Fallback version for CORS or other issues
                        document.getElementById('version-info').textContent = 'Version 1.0.0 (Local Development)';
                    }
                }
                
                loadVersion();
            </script>
        </div>
    </div>

    <!-- Password Setup Modal -->
    <div id="passwordSetupModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="passwordModalTitle">üîí Set Password</h3>
            </div>
            <div class="modal-body">
                <p id="passwordModalMessage">Enter a password to protect your notes:</p>
                <input type="password" id="newPasswordInput" class="password-input" placeholder="Enter new password..." autocomplete="new-password">
                <input type="password" id="confirmPasswordInput" class="password-input" placeholder="Confirm password..." autocomplete="new-password">
                <input type="password" id="currentPasswordInput" class="password-input" placeholder="Enter current password..." autocomplete="current-password" style="display: none;">
                <div id="passwordSetupError" class="error-message" style="display: none;">
                    Passwords do not match or other error.
                </div>
            </div>
            <div class="modal-footer">
                <button id="passwordSetupCancel" class="btn btn-secondary">Cancel</button>
                <button id="passwordSetupConfirm" class="btn btn-primary">üîí Set Password</button>
            </div>
        </div>
    </div>


    <div id="googleAuthModal" class="modal-overlay" style="display: none;">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h3>üîó Connect to Google Drive</h3>
            </div>
            <div class="modal-body">
                <div class="auth-provider-logo">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjRkZDMTA3IiBkPSJtNDMuNjExIDIwLjA4M0g0Mi41MDJ2LS4zMzNIMjR2OGgxMS4zMDNjLTEuNjQ5IDQuNjU3LTYuMDggOC02My4zMDMgOC02LjYyNyAwLTEyLTUuMzczLTEyLTEyIDAtNi42MjcgNS4zNzMtMTIgMTItMTIgMy4wNTkgMCA1Ljg0MiAxLjE1NCA3Ljk2MSAzLjAzOWw1LjY1Ny01LjY1N0MyOS42NTggNS4wMzggMjcuMDI2IDQgMjQgNCA5LjMzIDQgMCAxNS42OCAwIDMyczcuNjc3IDI4IDI0IDI4IDI0IDAgMjQtMjhjMC0xLjM0MS0uMTM4LTIuNjUtLjM4OS0zLjkxN3oiLz4KICA8cGF0aCBmaWxsPSIjRkYzRDA1IiBkPSJtNi4zMDYgMTQuNjkxIDYuNTcxIDQuODE5QzE0Ljg5MSAxNS43ODUgMTkuMDY3IDEyIDI0IDEyYzMuMDU5IDAgNS44NDIgMS4xNTQgNy45NjEgMy4wMzlsNS42NTctNS42NTdDMzQuNjU4IDUuMDM3IDI5LjAyNiA0IDI0IDQgMTYuMzE4IDQgOS42NTYgOC4zMzcgNi4zMDYgMTQuNjkxeiIvPgogIDxwYXRoIGZpbGw9IiM0Q0FGNTASCSA9Im0yNCA0NGMxNS4xNzQgMCAyMy45ODYtMTIuNTg1IDI0LTI4IDAtLjg1Ni0uMDU0LTEuNzA3LS4xNzctMi41NGwtOC4wMTQgNS45NjFjLTEuNzQ0IDMuMjc5LTUuMDAyIDUuNTc5LTguODA5IDUuNTc5LTQuNzQ3IDAtOC44NTgtMy4zMDQtOS44OTYtNy44MzlsLTYuNTI0IDUuMDI1QzExLjQ4IDM5LjQ0NiAxNy40MTggNDQgMjQgNDR6Ii8+CiAgPHBhdGggZmlsbD0iIzM0QTg1MyIgZD0iTTQyLjUwMiAyNi42NDJIMTB2OGgxMS4zMDNjLTEuNjQ5IDQuNjU3LTYuMDggOC02My4zMDMgOC02LjYyNyAwLTEyLTUuMzczLTEyLTEyIDAtNi42MjcgNS4zNzMtMTIgMTItMTIgMy4wNTkgMCA1Ljg0MiAxLjE1NCA3Ljk2MSAzLjAzOWw1LjY1Ny01LjY1N0MyOS42NTggNS4wMzggMjcuMDI2IDQgMjQgNGMtMTAuNjY5IDAtMTkuNjY3IDguNjQ5LTE5LjY2NyAyMCAwIDEyIDktMTMgOS0xMyAwIDAtMS4wNS0uMzUgMS0zaDEuMyAx LjM0MS0uMTM4IDIuNjUtLjM4OSAzLjkxN3oiLz4KPC9zdmc+" alt="Google" class="provider-logo">
                </div>
                <p class="auth-description">Sign in to your Google account to connect Google Drive for cloud synchronization</p>
                
                <!-- Email/Password Method -->
                <div class="auth-method" id="google-credentials-method">
                    <div class="auth-form">
                        <input type="email" id="googleEmailInput" class="auth-input" placeholder="Enter your Gmail address" autocomplete="username email" name="email">
                        <input type="password" id="googlePasswordInput" class="auth-input" placeholder="Enter your password" autocomplete="current-password" name="password">
                        <div class="auth-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="googleRememberMe">
                                <span>Remember me</span>
                            </label>
                        </div>
                        <button id="googleSignInBtn" class="btn btn-primary auth-submit">üîê Sign In</button>
                    </div>
                </div>

                <div id="googleAuthError" class="error-message" style="display: none;"></div>
                
                <div class="auth-footer">
                    <p><a href="#" id="googleForgotPassword">Forgot password?</a></p>
                    <p><a href="#" id="googleCreateAccount">Create account</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="googleAuthCancel" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Microsoft OneDrive Sign-In Modal -->
    <div id="microsoftAuthModal" class="modal-overlay" style="display: none;">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h3>üîó Connect to OneDrive</h3>
            </div>
            <div class="modal-body">
                <div class="auth-provider-logo">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjRkY1NzIyIiBkPSJNNiA2djM2aDM2VjZINnoiLz4KICA8cGF0aCBmaWxsPSIjRkZGRkZGIiBkPSJNMzAgMjJoLTR2LTRoNHY0em0wIDZoLTR2LTRoNHY0em0wIDZoLTR2LTRoNHY0em0tNiAwSDEwVjE2aDE0djE4eiIvPgo8L3N2Zz4=" alt="Microsoft" class="provider-logo">
                </div>
                <p class="auth-description">Sign in to your Microsoft account to connect OneDrive for cloud synchronization</p>
                
                <!-- Email/Password Method -->
                <div class="auth-method" id="microsoft-credentials-method">
                    <div class="auth-form">
                        <input type="email" id="microsoftEmailInput" class="auth-input" placeholder="Enter your Microsoft email" autocomplete="username email" name="email">
                        <input type="password" id="microsoftPasswordInput" class="auth-input" placeholder="Enter your password" autocomplete="current-password" name="password">
                        <div class="auth-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="microsoftRememberMe">
                                <span>Remember me</span>
                            </label>
                        </div>
                        <button id="microsoftSignInBtn" class="btn btn-primary auth-submit">üîê Sign In</button>
                    </div>
                </div>

                <div id="microsoftAuthError" class="error-message" style="display: none;"></div>
                
                <div class="auth-footer">
                    <p><a href="#" id="microsoftForgotPassword">Forgot password?</a></p>
                    <p><a href="#" id="microsoftCreateAccount">Create account</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="microsoftAuthCancel" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Dropbox Sign-In Modal -->
    <div id="dropboxAuthModal" class="modal-overlay" style="display: none;">
        <div class="modal-content auth-modal">
            <div class="modal-header">
                <h3>üîó Connect to Dropbox</h3>
            </div>
            <div class="modal-body">
                <div class="auth-provider-logo">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBmaWxsPSIjMDA3N0ZGIiBkPSJNNy4xIDEyTDI0IDI0bDE2LjktMTJMMjQgMHoiLz4KICA8cGF0aCBmaWxsPSIjMDA1REQ3IiBkPSJNNy4xIDEyIDI0IDI0djEyTDcuMSAyNHoiLz4KICA8cGF0aCBmaWxsPSIjMDA5N0ZGIiBkPSJNNDAuOSAxMiAyNCAyNHYxMmwxNi45LTEyeiIvPgogIDxwYXRoIGZpbGw9IiMwMDc3RkYiIGQ9Ik0yNCAyNGwtMTYuOSAxMkwyNCA0OGwxNi45LTEyeiIvPgo8L3N2Zz4=" alt="Dropbox" class="provider-logo">
                </div>
                <p class="auth-description">Sign in to your Dropbox account to connect Dropbox for cloud synchronization</p>
                
                <!-- Email/Password Method -->
                <div class="auth-method" id="dropbox-credentials-method">
                    <div class="auth-form">
                        <input type="email" id="dropboxEmailInput" class="auth-input" placeholder="Enter your Dropbox email" autocomplete="username email" name="email">
                        <input type="password" id="dropboxPasswordInput" class="auth-input" placeholder="Enter your password" autocomplete="current-password" name="password">
                        <div class="auth-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="dropboxRememberMe">
                                <span>Remember me</span>
                            </label>
                        </div>
                        <button id="dropboxSignInBtn" class="btn btn-primary auth-submit">üîê Sign In</button>
                    </div>
                </div>

                <div id="dropboxAuthError" class="error-message" style="display: none;"></div>
                
                <div class="auth-footer">
                    <p><a href="#" id="dropboxForgotPassword">Forgot password?</a></p>
                    <p><a href="#" id="dropboxCreateAccount">Create account</a></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="dropboxAuthCancel" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
            width: 90vw;
            margin: 20px;
            box-sizing: border-box;
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #1e293b;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-body p {
            margin: 0 0 16px 0;
            color: #64748b;
            line-height: 1.5;
        }
        .password-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            margin-bottom: 12px;
            box-sizing: border-box;
            max-width: 100%;
        }
        .password-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 8px;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .cloud-select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            font-size: 0.9rem;
            margin-right: 8px;
        }
        .sync-options {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            border: 1px solid #e9ecef;
        }
        .sync-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .sync-option:last-child {
            margin-bottom: 0;
        }
        .sync-option input[type="checkbox"] {
            margin-right: 8px;
        }
        .sync-option label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        .sync-frequency {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }
        .sync-frequency label {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }
                 .sync-frequency select {
             padding: 4px 8px;
             border: 1px solid #ccc;
             border-radius: 3px;
             background: #fff;
         }
         .sync-status-info {
             margin-top: 12px;
             padding: 8px;
             background: #f8f9fa;
             border-radius: 4px;
             border: 1px solid #e9ecef;
         }
         .sync-status-info small {
             color: #6c757d;
             font-size: 0.85rem;
         }
        /* Authentication Modal Styles */
        .auth-modal .modal-content {
            max-width: 450px;
            width: 95vw;
        }
        .auth-provider-logo {
            text-align: center;
            margin-bottom: 16px;
        }
        .provider-logo {
            width: 48px;
            height: 48px;
            border-radius: 8px;
        }
        .auth-description {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .auth-method {
            margin-bottom: 20px;
        }
        .auth-method-title {
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
            font-size: 0.95rem;
        }
        .auth-method-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }
        .oauth-btn {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .oauth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        .auth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }
        .auth-divider span {
            background: white;
            padding: 0 16px;
            color: #666;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }
        .auth-form {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .auth-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            margin-bottom: 12px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .auth-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .auth-options {
            margin: 12px 0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #555;
        }
        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }
        .auth-submit {
            width: 100%;
            padding: 10px;
            font-weight: bold;
            margin-top: 8px;
        }
        .auth-footer {
            text-align: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }
        .auth-footer p {
            margin: 4px 0;
        }
        .auth-footer a {
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .auth-footer a:hover {
            text-decoration: underline;
        }
        /* API Configuration Styles */
        .api-config {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 16px;
            margin-top: 12px;
        }
        .api-provider-selector {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .api-provider-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        .api-provider-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .api-provider-section:last-of-type {
            margin-bottom: 16px;
        }
        .api-provider-section h4 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 1rem;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .api-input-group {
            margin-bottom: 12px;
        }
        .api-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            color: #495057;
            font-size: 0.9rem;
        }
        .api-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            box-sizing: border-box;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .api-input:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .api-input[type="password"] {
            font-family: monospace;
        }
        .api-help {
            margin: 8px 0 0 0;
            font-size: 0.8rem;
            color: #6c757d;
        }
        .api-help a {
            color: #007bff;
            text-decoration: none;
        }
        .api-help a:hover {
            text-decoration: underline;
        }
        .api-actions {
            border-top: 1px solid #e9ecef;
            padding-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .api-status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 8px;
        }
        .api-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .api-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .api-status.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>

    <script>
        let storage = null;

        // Initialize storage
        async function initStorage() {
            try {
                if (typeof EncryptedStorage !== 'undefined') {
                    storage = new EncryptedStorage();
                } else {
                    // Fallback storage
                    storage = {
                        async saveEncrypted(key, data) {
                            localStorage.setItem(key, JSON.stringify(data));
                            return true;
                        },
                        async loadEncrypted(key) {
                            const data = localStorage.getItem(key);
                            return data ? JSON.parse(data) : null;
                        },
                        async clearAll() {
                            localStorage.clear();
                            return true;
                        }
                    };
                }
                updateStorageDisplay();
            } catch (error) {
                console.error('Storage initialization failed:', error);
            }
        }

        async function updateStorageDisplay() {
            // Update tools count
            const toolKeys = ['notebook-data', 'pomodoro-data', 'checklist-data', 'eisenhower-data'];
            let toolsWithData = 0;
            
            for (const key of toolKeys) {
                try {
                    const data = await storage.loadEncrypted(key);
                    if (data) toolsWithData++;
                } catch (error) {
                    console.error(`Error checking ${key}:`, error);
                }
            }
            
            document.getElementById('tools-count').textContent = `${toolsWithData} of 4 tools`;
            
            // Update storage type
            const hasEncryption = typeof EncryptedStorage !== 'undefined';
            document.getElementById('storage-type').textContent = hasEncryption ? 'Encrypted Local Storage' : 'Local Storage (Fallback)';
            
            // Update password protection status
            await updatePasswordStatus();
            
            // Update PWA status
            updatePWAStatus();
        }

        async function updatePasswordStatus() {
            try {
                const notebookData = await storage.loadEncrypted('notebook-data');
                const isPasswordEnabled = notebookData?.settings?.passwordProtected || false;
                
                const statusElement = document.getElementById('password-enabled-status');
                const enableBtn = document.getElementById('enable-password-btn');
                const changeBtn = document.getElementById('change-password-btn');
                const disableBtn = document.getElementById('disable-password-btn');
                
                if (isPasswordEnabled) {
                    statusElement.textContent = 'üîí Enabled';
                    statusElement.style.color = '#059669';
                    enableBtn.style.display = 'none';
                    changeBtn.style.display = 'inline-block';
                    disableBtn.style.display = 'inline-block';
                } else {
                    statusElement.textContent = 'üîì Disabled';
                    statusElement.style.color = '#dc2626';
                    enableBtn.style.display = 'inline-block';
                    changeBtn.style.display = 'none';
                    disableBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking password status:', error);
                document.getElementById('password-enabled-status').textContent = 'Error';
            }
        }

        function updatePWAStatus() {
            // Check if app is installed or running locally
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true ||
                               document.referrer.includes('android-app://');
            
            // Check if running in iOS Safari
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isIOSSafari = isIOS && isSafari;
            
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' || 
                               window.location.protocol === 'file:';
            
            const installStatus = document.getElementById('install-status');
            const installBtn = document.getElementById('install-btn');
            const installItem = document.getElementById('install-item');
            
            if (isLocalhost) {
                // Hide entire install section when running locally
                installItem.style.display = 'none';
            } else if (isInstalled) {
                installStatus.textContent = '‚úÖ App is installed';
                installBtn.style.display = 'none';
            } else if (isIOSSafari) {
                // Special handling for iOS Safari
                installStatus.textContent = 'üì± Tap the share button and select "Add to Home Screen"';
                installBtn.style.display = 'none';
            } else if (checkInstallPrompt()) {
                installStatus.textContent = 'üì± App can be installed';
                installBtn.style.display = 'inline-block';
            } else {
                installStatus.textContent = 'üì± Install not available in this browser';
                installBtn.style.display = 'none';
            }
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    const swStatus = document.getElementById('sw-status');
                    const cacheStatus = document.getElementById('cache-status');
                    
                    if (registration) {
                        swStatus.textContent = '‚úÖ Active';
                        cacheStatus.textContent = '‚úÖ Available';
                    } else {
                        swStatus.textContent = '‚ùå Not registered';
                        cacheStatus.textContent = '‚ùå Not available';
                    }
                });
            } else {
                document.getElementById('sw-status').textContent = '‚ùå Not supported';
                document.getElementById('cache-status').textContent = '‚ùå Not available';
            }
            
            // Additional iOS-specific checks
            if (isIOSSafari) {
                // Check if the app is already added to home screen
                if (window.navigator.standalone === true) {
                    installStatus.textContent = '‚úÖ App is installed on home screen';
                    installBtn.style.display = 'none';
                } else {
                    installStatus.textContent = 'üì± Tap the share button and select "Add to Home Screen"';
                    installBtn.style.display = 'none';
                }
            }
        }

        async function exportAllData() {
            try {
                const allData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    app: 'Productivity Suite',
                    tools: {}
                };

                // Export data from all tools
                const toolKeys = [
                    { key: 'notebook-data', name: 'notebook' },
                    { key: 'pomodoro-data', name: 'pomodoro' },
                    { key: 'checklist-data', name: 'checklist' },
                    { key: 'eisenhower-data', name: 'eisenhower' }
                ];

                for (const {key, name} of toolKeys) {
                    try {
                        const data = await storage.loadEncrypted(key);
                        if (data) {
                            allData.tools[name] = data;
                        }
                    } catch (error) {
                        console.error(`Error exporting ${name}:`, error);
                    }
                }

                // Create and download file
                const blob = new Blob([JSON.stringify(allData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `productivity-suite-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚úÖ All data exported successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                alert('‚ùå Export failed: ' + error.message);
            }
        }

        async function importAllData() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);

                        if (!data.tools) {
                            throw new Error('Invalid backup file format');
                        }

                        // Import data to all tools
                        const toolKeys = [
                            { key: 'notebook-data', name: 'notebook' },
                            { key: 'pomodoro-data', name: 'pomodoro' },
                            { key: 'checklist-data', name: 'checklist' },
                            { key: 'eisenhower-data', name: 'eisenhower' }
                        ];

                        let importedCount = 0;
                        for (const {key, name} of toolKeys) {
                            if (data.tools[name]) {
                                try {
                                    await storage.saveEncrypted(key, data.tools[name]);
                                    importedCount++;
                                } catch (error) {
                                    console.error(`Error importing ${name}:`, error);
                                }
                            }
                        }

                        alert(`‚úÖ Data imported successfully!\n${importedCount} tools updated.\nPlease refresh to see changes.`);
                        updateStorageDisplay();
                    } catch (error) {
                        console.error('Import failed:', error);
                        alert('‚ùå Import failed: ' + error.message);
                    }
                };

                fileInput.click();
            } catch (error) {
                console.error('Import setup failed:', error);
                alert('‚ùå Import setup failed: ' + error.message);
            }
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to clear ALL data?\n\nThis will permanently delete:\n- All notebook notes\n- Pomodoro session history\n- All checklist tasks\n- Eisenhower matrix tasks\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                // Clear data from all tools
                const toolKeys = ['notebook-data', 'pomodoro-data', 'checklist-data', 'eisenhower-data'];
                
                for (const key of toolKeys) {
                    try {
                        localStorage.removeItem(key);
                    } catch (error) {
                        console.error(`Error clearing ${key}:`, error);
                    }
                }

                // Clear any additional storage
                if (storage && storage.clearAll) {
                    await storage.clearAll();
                }

                alert('‚úÖ All data cleared successfully!\nThe page will now reload.');
                updateStorageDisplay();
                
                // Reload page after delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                console.error('Clear failed:', error);
                alert('‚ùå Clear failed: ' + error.message);
            }
        }

        // Check if install prompt is available
        function checkInstallPrompt() {
            // Check for beforeinstallprompt event (Chrome/Edge)
            if ('BeforeInstallPromptEvent' in window) {
                return true;
            }
            
            // Check for iOS Safari
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            if (isIOS && isSafari) {
                return true; // iOS Safari supports manual installation
            }
            
            return false;
        }

        function installApp() {
            if (window.parent && window.parent !== window) {
                // We're in an iframe, send message to parent
                window.parent.postMessage({ action: 'install-app' }, '*');
            } else {
                alert('App installation is handled by the main application.');
            }
        }

        // Function to check if PWA is installed
        function checkIfPWAInstalled() {
            // Check for standalone mode (Android/Chrome)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            
            // Check for iOS standalone mode
            const isIOSStandalone = window.navigator.standalone === true;
            
            // Check for Android app mode
            const isAndroidApp = document.referrer.includes('android-app://');
            
            // Check for TWA (Trusted Web Activity)
            const isTWA = window.matchMedia('(display-mode: minimal-ui)').matches;
            
            return isStandalone || isIOSStandalone || isAndroidApp || isTWA;
        }

        async function previewData() {
            try {
                const toolKeys = [
                    { key: 'notebook-data', name: 'Notebook' },
                    { key: 'pomodoro-data', name: 'Pomodoro' },
                    { key: 'checklist-data', name: 'Checklist' },
                    { key: 'eisenhower-data', name: 'Eisenhower' }
                ];

                let preview = 'üìä Data Overview:\n\n';
                let totalSize = 0;

                for (const {key, name} of toolKeys) {
                    try {
                        const data = await storage.loadEncrypted(key);
                        if (data) {
                            const size = JSON.stringify(data).length;
                            totalSize += size;
                            preview += `${name}: ${(size / 1024).toFixed(1)} KB\n`;
                            
                            // Add specific data counts
                            if (name === 'Notebook' && data.notes) {
                                preview += `  - ${data.notes.length} notes\n`;
                            } else if (name === 'Pomodoro' && data.sessions) {
                                preview += `  - ${data.sessions.length} sessions\n`;
                            } else if (name === 'Checklist' && data.projects) {
                                preview += `  - ${data.projects.length} projects\n`;
                            } else if (name === 'Eisenhower' && data.tasks) {
                                preview += `  - ${data.tasks.length} tasks\n`;
                            }
                        } else {
                            preview += `${name}: No data\n`;
                        }
                    } catch (error) {
                        preview += `${name}: Error reading data\n`;
                    }
                }

                preview += `\nTotal size: ${(totalSize / 1024).toFixed(1)} KB`;
                alert(preview);
            } catch (error) {
                console.error('Preview failed:', error);
                alert('‚ùå Preview failed: ' + error.message);
            }
        }

        // Password management functions
        async function hashPassword(password) {
            // Simple hash function for demo - in production, use stronger hashing
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'notes-salt-2025');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function verifyPassword(inputPassword, storedHash) {
            const inputHash = await hashPassword(inputPassword);
            return inputHash === storedHash;
        }

        function showPasswordModal(mode, currentHash = null) {
            const modal = document.getElementById('passwordSetupModal');
            const title = document.getElementById('passwordModalTitle');
            const message = document.getElementById('passwordModalMessage');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const currentPasswordInput = document.getElementById('currentPasswordInput');
            const confirmBtn = document.getElementById('passwordSetupConfirm');
            const errorDiv = document.getElementById('passwordSetupError');

            // Reset form
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            currentPasswordInput.value = '';
            errorDiv.style.display = 'none';

            if (mode === 'enable') {
                title.textContent = 'üîí Enable Password Protection';
                message.textContent = 'Set a password to protect your notes:';
                currentPasswordInput.style.display = 'none';
                confirmBtn.textContent = 'üîí Enable Protection';
            } else if (mode === 'change') {
                title.textContent = 'üîë Change Password';
                message.textContent = 'Enter your current password and a new password:';
                currentPasswordInput.style.display = 'block';
                confirmBtn.textContent = 'üîë Change Password';
            } else if (mode === 'disable') {
                title.textContent = 'üîì Disable Password Protection';
                message.textContent = 'Enter your current password to disable protection:';
                newPasswordInput.style.display = 'none';
                confirmPasswordInput.style.display = 'none';
                currentPasswordInput.style.display = 'block';
                confirmBtn.textContent = 'üîì Disable Protection';
            }

            // Ensure proper display for enable mode
            if (mode === 'enable') {
                newPasswordInput.style.display = 'block';
                confirmPasswordInput.style.display = 'block';
            } else if (mode === 'change') {
                newPasswordInput.style.display = 'block';
                confirmPasswordInput.style.display = 'block';
            }

            modal.style.display = 'flex';
            setTimeout(() => {
                if (mode === 'disable' || mode === 'change') {
                    currentPasswordInput.focus();
                } else {
                    newPasswordInput.focus();
                }
            }, 100);

            return new Promise((resolve) => {
                const handleConfirm = async () => {
                    try {
                        if (mode === 'enable') {
                            const newPassword = newPasswordInput.value;
                            const confirmPassword = confirmPasswordInput.value;

                            if (!newPassword || newPassword.length < 4) {
                                showError('Password must be at least 4 characters long.');
                                return;
                            }

                            if (newPassword !== confirmPassword) {
                                showError('Passwords do not match.');
                                return;
                            }

                            const passwordHash = await hashPassword(newPassword);
                            hidePasswordModal();
                            resolve({ success: true, hash: passwordHash });

                        } else if (mode === 'change') {
                            const currentPassword = currentPasswordInput.value;
                            const newPassword = newPasswordInput.value;
                            const confirmPassword = confirmPasswordInput.value;

                            if (!await verifyPassword(currentPassword, currentHash)) {
                                showError('Current password is incorrect.');
                                return;
                            }

                            if (!newPassword || newPassword.length < 4) {
                                showError('New password must be at least 4 characters long.');
                                return;
                            }

                            if (newPassword !== confirmPassword) {
                                showError('New passwords do not match.');
                                return;
                            }

                            const passwordHash = await hashPassword(newPassword);
                            hidePasswordModal();
                            resolve({ success: true, hash: passwordHash });

                        } else if (mode === 'disable') {
                            const currentPassword = currentPasswordInput.value;

                            if (!await verifyPassword(currentPassword, currentHash)) {
                                showError('Password is incorrect.');
                                return;
                            }

                            hidePasswordModal();
                            resolve({ success: true });
                        }
                    } catch (error) {
                        showError('An error occurred. Please try again.');
                        console.error('Password operation error:', error);
                    }
                };

                const handleCancel = () => {
                    hidePasswordModal();
                    resolve({ success: false });
                };

                const showError = (message) => {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                };

                // Set up event listeners
                document.getElementById('passwordSetupConfirm').onclick = handleConfirm;
                document.getElementById('passwordSetupCancel').onclick = handleCancel;

                // Handle Enter key
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') handleConfirm();
                    if (e.key === 'Escape') handleCancel();
                };

                newPasswordInput.onkeypress = handleKeyPress;
                confirmPasswordInput.onkeypress = handleKeyPress;
                currentPasswordInput.onkeypress = handleKeyPress;
            });
        }

        function hidePasswordModal() {
            document.getElementById('passwordSetupModal').style.display = 'none';
            // Clean up event listeners
            document.getElementById('passwordSetupConfirm').onclick = null;
            document.getElementById('passwordSetupCancel').onclick = null;
            document.getElementById('newPasswordInput').onkeypress = null;
            document.getElementById('confirmPasswordInput').onkeypress = null;
            document.getElementById('currentPasswordInput').onkeypress = null;
        }

        async function enablePasswordProtection() {
            const result = await showPasswordModal('enable');
            if (!result.success) return;

            try {
                const notebookData = await storage.loadEncrypted('notebook-data') || {};
                notebookData.settings = notebookData.settings || {};
                notebookData.settings.passwordProtected = true;
                notebookData.settings.passwordHash = result.hash;

                await storage.saveEncrypted('notebook-data', notebookData);
                await updatePasswordStatus();
                
                // Notify notes list of changes
                notifyPasswordSettingsChanged();
                
                alert('‚úÖ Password protection enabled!\nYour notes are now secured with a password.');
            } catch (error) {
                console.error('Failed to enable password protection:', error);
                alert('‚ùå Failed to enable password protection: ' + error.message);
            }
        }

        async function changePassword() {
            try {
                const notebookData = await storage.loadEncrypted('notebook-data');
                const currentHash = notebookData?.settings?.passwordHash;
                
                if (!currentHash) {
                    alert('‚ùå No password is currently set.');
                    return;
                }

                const result = await showPasswordModal('change', currentHash);
                if (!result.success) return;

                notebookData.settings.passwordHash = result.hash;
                await storage.saveEncrypted('notebook-data', notebookData);
                await updatePasswordStatus();
                
                // Notify notes list of changes
                notifyPasswordSettingsChanged();
                
                alert('‚úÖ Password changed successfully!');
            } catch (error) {
                console.error('Failed to change password:', error);
                alert('‚ùå Failed to change password: ' + error.message);
            }
        }

        async function disablePasswordProtection() {
            try {
                const notebookData = await storage.loadEncrypted('notebook-data');
                const currentHash = notebookData?.settings?.passwordHash;
                
                if (!currentHash) {
                    alert('‚ùå Password protection is not currently enabled.');
                    return;
                }

                const result = await showPasswordModal('disable', currentHash);
                if (!result.success) return;

                notebookData.settings.passwordProtected = false;
                notebookData.settings.passwordHash = null;
                await storage.saveEncrypted('notebook-data', notebookData);
                await updatePasswordStatus();
                
                // Notify notes list of changes
                notifyPasswordSettingsChanged();
                
                alert('‚úÖ Password protection disabled!\nYour notes are no longer password protected.');
            } catch (error) {
                console.error('Failed to disable password protection:', error);
                alert('‚ùå Failed to disable password protection: ' + error.message);
            }
        }

        function notifyPasswordSettingsChanged() {
            // Try to notify the notes list if it's in an iframe
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ action: 'password-settings-changed' }, '*');
            }
            
            // Also try to find and notify any iframe containing notes-list
            const frames = document.querySelectorAll('iframe');
            frames.forEach(frame => {
                try {
                    frame.contentWindow.postMessage({ action: 'password-settings-changed' }, '*');
                } catch (error) {
                    // Ignore cross-origin errors
                }
            });

            // Send a broadcast message to all windows/tabs
            try {
                localStorage.setItem('password-settings-changed', Date.now().toString());
                localStorage.removeItem('password-settings-changed');
            } catch (error) {
                // Ignore localStorage errors
            }
        }

        // Event listeners
        document.getElementById('enable-password-btn').addEventListener('click', enablePasswordProtection);
        document.getElementById('change-password-btn').addEventListener('click', changePassword);
        document.getElementById('disable-password-btn').addEventListener('click', disablePasswordProtection);
        document.getElementById('export-btn').addEventListener('click', exportAllData);
        document.getElementById('import-btn').addEventListener('click', importAllData);
        document.getElementById('preview-btn').addEventListener('click', previewData);
        document.getElementById('clear-btn').addEventListener('click', clearAllData);
        document.getElementById('install-btn').addEventListener('click', installApp);

        // Cloud Storage Management - using external cloud-auth.js
        let cloudStorageManager = null;
        let cloudAuthUI = null;

                 // Initialize cloud storage manager
         async function initCloudStorage() {
             cloudStorageManager = new CloudStorageManager();
             cloudAuthUI = new CloudAuthUI(cloudStorageManager);
             await cloudStorageManager.initialize(storage);
             cloudAuthUI.initialize();
             
             // Show sync options if connected
             updateSyncOptionsVisibility();
             updateSyncStatus();
             
             // Set up periodic status updates
             setInterval(updateSyncStatus, 30000); // Update every 30 seconds
         }

         function updateSyncOptionsVisibility() {
             const syncOptions = document.getElementById('sync-options');
             if (cloudStorageManager && cloudStorageManager.isConnected) {
                 syncOptions.style.display = 'block';
                 
                 // Update checkbox states
                 const encryptCheckbox = document.getElementById('encrypt-before-sync');
                 const offlineCheckbox = document.getElementById('sync-when-offline');
                 const frequencySelect = document.getElementById('sync-frequency-select');
                 
                 if (encryptCheckbox) {
                     encryptCheckbox.checked = cloudStorageManager.encryptBeforeSync;
                 }
                 if (offlineCheckbox) {
                     offlineCheckbox.checked = cloudStorageManager.offlineSyncEnabled || true;
                 }
                 if (frequencySelect) {
                     frequencySelect.value = cloudStorageManager.syncFrequency || 15;
                 }
             } else {
                 syncOptions.style.display = 'none';
             }
         }

                 // Sync settings handlers
         function handleEncryptionToggle() {
             const encryptCheckbox = document.getElementById('encrypt-before-sync');
             if (cloudStorageManager) {
                 cloudStorageManager.setEncryptBeforeSync(encryptCheckbox.checked);
             }
         }

         function handleOfflineSyncToggle() {
             const offlineCheckbox = document.getElementById('sync-when-offline');
             if (cloudStorageManager) {
                 cloudStorageManager.setOfflineSyncEnabled(offlineCheckbox.checked);
             }
         }

         function handleSyncFrequencyChange() {
             const frequencySelect = document.getElementById('sync-frequency-select');
             const frequency = parseInt(frequencySelect.value);
             if (cloudStorageManager) {
                 cloudStorageManager.setSyncFrequency(frequency);
                 if (frequency === 0) {
                     // Manual only - stop auto sync
                     cloudStorageManager.stopAutoSync();
                 } else if (cloudStorageManager.autoSyncEnabled) {
                     // Restart auto sync with new frequency
                     cloudStorageManager.startAutoSync();
                 }
             }
         }

         function updateSyncStatus() {
             const statusElement = document.getElementById('current-sync-status');
             if (!cloudStorageManager) {
                 statusElement.textContent = 'Cloud manager not initialized';
                 return;
             }

             const isConnected = cloudStorageManager.isConnected;
             const autoSyncEnabled = cloudStorageManager.autoSyncEnabled;
             const frequency = cloudStorageManager.syncFrequency;
             const isLocal = window.location.protocol === 'file:';

             if (!isConnected) {
                 statusElement.textContent = 'Not connected to cloud storage';
             } else if (isLocal) {
                 statusElement.textContent = 'Local development mode - cloud detection disabled';
             } else if (autoSyncEnabled && frequency > 0) {
                 statusElement.textContent = `Auto-sync enabled (every ${frequency} minutes)`;
             } else if (autoSyncEnabled && frequency === 0) {
                 statusElement.textContent = 'Manual sync only';
             } else {
                 statusElement.textContent = 'Auto-sync disabled';
             }
         }

         // Sync settings event listeners
         document.getElementById('encrypt-before-sync').addEventListener('change', handleEncryptionToggle);
         document.getElementById('sync-when-offline').addEventListener('change', handleOfflineSyncToggle);
         document.getElementById('sync-frequency-select').addEventListener('change', handleSyncFrequencyChange);


                 // Initialize when page loads
         window.addEventListener('load', async () => {
             await initStorage();
             await initCloudStorage();
             
             // Setup update check functionality
             setupUpdateCheck();
             
             // Set up periodic PWA status checks
             setInterval(updatePWAStatus, 5000); // Check every 5 seconds
             
             // Also check when window gains focus (user returns to app)
             window.addEventListener('focus', updatePWAStatus);
         });

         // Listen for cloud sync status updates
         window.addEventListener('message', (event) => {
             if (event.data && event.data.type === 'cloud-sync-status') {
                 updateSyncOptionsVisibility();
                 updateSyncStatus();
             }
         });

         // Update check functionality
         function setupUpdateCheck() {
             const checkUpdateBtn = document.getElementById('check-update-btn');
             const updateStatus = document.getElementById('update-status');
             
             if (checkUpdateBtn) {
                 checkUpdateBtn.addEventListener('click', async () => {
                     try {
                         checkUpdateBtn.disabled = true;
                         checkUpdateBtn.textContent = 'üîÑ Checking...';
                         updateStatus.textContent = 'Checking for updates...';
                         
                         // Call the main app's update check function
                         if (window.app && window.app.checkForUpdates) {
                             await window.app.checkForUpdates();
                         } else {
                             // Fallback: manually trigger service worker update
                             if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                                 await navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                                 updateStatus.textContent = 'Update check completed. Refresh the page to apply updates.';
                             } else {
                                 updateStatus.textContent = 'No service worker found.';
                             }
                         }
                         
                         setTimeout(() => {
                             checkUpdateBtn.disabled = false;
                             checkUpdateBtn.textContent = 'üîÑ Check for Updates';
                         }, 2000);
                         
                     } catch (error) {
                         console.error('Update check failed:', error);
                         updateStatus.textContent = 'Update check failed: ' + error.message;
                         checkUpdateBtn.disabled = false;
                         checkUpdateBtn.textContent = 'üîÑ Check for Updates';
                     }
                 });
             }
         }
    </script>
</body>
</html>
